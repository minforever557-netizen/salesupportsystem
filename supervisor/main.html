<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Management - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .sup-container { max-width: 1100px; margin: 20px auto; width: 95%; }
        .job-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .job-grid { display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; align-items: center; }
        .btn-action { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-process { background: #f59e0b; color: white; }
        .btn-close { background: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; }
    </style>
</head>
<body style="background: #f8fafc;">

    <div class="sup-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (Active Jobs)</h2>
            <div id="supEmail" style="font-weight: 600; color: #64748b;">Supervisor</div>
        </div>

        <div id="activeJobList">
            <p style="text-align:center; padding:50px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</p>
        </div>
    </div>

    <div id="actionModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô</h3>
            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</label>
                <select id="modalStatus" class="input-field">
                    <option value="In Progress">In Progress (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</option>
                    <option value="Closed">Closed (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô/‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
                <textarea id="modalNote" class="input-field" rows="4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveAction()" class="btn-action btn-close" style="flex:1;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button onclick="closeModal()" class="btn-action" style="flex:1; background:#e2e8f0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentJobId = null;

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            document.getElementById('supEmail').innerText = "Sup: " + user.email;
            loadJobs();
        }
    });

    function loadJobs() {
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î (Open ‡∏´‡∏£‡∏∑‡∏≠ In Progress)
        const q = query(collection(db, "tickets"), where("status", "in", ["Open", "In Progress"]));
        
        onSnapshot(q, (snap) => {
            const listDiv = document.getElementById('activeJobList');
            let html = '';
            snap.forEach(docSnap => {
                const t = docSnap.data();
                const statusClass = t.status === 'Open' ? 'bg-open' : 'bg-process';
                
                html += `
                    <div class="job-card">
                        <div class="job-grid">
                            <div>
                                <b style="font-size: 1.1rem; color: #1e293b;">${t.internetNo}</b> 
                                <span class="status-badge ${statusClass}" style="margin-left:10px;">${t.status}</span>
                                <div style="margin-top:5px; color:#64748b;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${t.topic} | Sale: ${t.email.split('@')[0]}</div>
                            </div>
                            <div style="font-size: 0.85rem; color: #94a3b8;">
                                ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${t.createdAt ? t.createdAt.toDate().toLocaleString('th-TH') : '-'}
                            </div>
                            <div>
                                <button class="btn-action btn-process" onclick="openModal('${docSnap.id}', '${t.status}', '${t.supNote || ''}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html || '<div class="card" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
        });
    }

    window.openModal = (id, status, note) => {
        currentJobId = id;
        document.getElementById('modalStatus').value = status;
        document.getElementById('modalNote').value = note;
        document.getElementById('actionModal').style.display = 'block';
    };

    window.closeModal = () => { document.getElementById('actionModal').style.display = 'none'; };

    window.saveAction = async () => {
        const newStatus = document.getElementById('modalStatus').value;
        const newNote = document.getElementById('modalNote').value;
        
        try {
            await updateDoc(doc(db, "tickets", currentJobId), {
                status: newStatus,
                supNote: newNote,
                updatedAt: serverTimestamp(),
                processedBy: auth.currentUser.email
            });
            alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            closeModal();
        } catch (e) { alert(e.message); }
    };
</script>
</body>
</html>
