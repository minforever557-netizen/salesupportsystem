<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
</head>
<body>

<div id="sidebarOverlay" class="sidebar-overlay"></div>

<div class="dashboard-layout">

    <!-- ===== SIDEBAR ===== -->
    <aside id="sidebar" class="dashboard-sidebar">
        <h2>SUPERVISOR</h2>
        <nav class="dashboard-nav">
            <a href="main.html"><i class="ri-dashboard-line"></i> Dashboard</a>
            <a href="history_all.html" class="active"><i class="ri-ticket-line"></i> Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            <a href="manage-job.html"><i class="ri-settings-3-line"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</a>
            <a href="#" id="logoutBtn" class="dashboard-logout">
                <i class="ri-logout-box-line"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </a>
        </nav>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="dashboard-main">

        <!-- TOP -->
        <div class="dashboard-top">
            <button id="hamburger" class="hamburger">
                <i class="ri-menu-line"></i>
            </button>
            <div class="dashboard-user" id="userEmail">-</div>
        </div>

        <h1>üìÇ Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
        <p class="dashboard-desc">Realtime Update ‡∏à‡∏≤‡∏Å Firestore</p>

        <!-- FILTER -->
        <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
            <select id="statusFilter" class="input" style="max-width:200px;">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="Open">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="Done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            </select>

            <input id="searchInput" class="input"
                   placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Internet No"
                   style="max-width:260px;">
        </div>

        <!-- TICKET LIST -->
        <div id="ticketList" class="dashboard-menu"></div>

    </main>
</div>

<!-- ===== TOAST (Step 3) ===== -->
<div id="toast" class="toast-success">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
    apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
    authDomain: "sale-support-system.firebaseapp.com",
    projectId: "sale-support-system",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Auth Guard */
onAuthStateChanged(auth, user => {
    if (!user) location.href = "../index.html";
    userEmail.innerText = user.email;
});

/* Toast Function (Step 3) */
function showToast(text, type = "success") {
    const toast = document.getElementById("toast");
    toast.innerText = text;
    toast.className = `toast-${type} show`;
    setTimeout(() => toast.classList.remove("show"), 2500);
}

/* Load Tickets (Realtime) */
onSnapshot(collection(db, "tickets"), snap => {
    renderTickets(snap.docs.map(d => d.data()));
});

/* Render */
function renderTickets(tickets) {
    const status = statusFilter.value;
    const keyword = searchInput.value.toLowerCase();

    ticketList.innerHTML = "";

    tickets
        .filter(t =>
            (!status || t.status === status) &&
            (!keyword || t.internetNo.toLowerCase().includes(keyword))
        )
        .forEach(t => {
            const card = document.createElement("a");
            card.className = "menu-tile";
            card.innerHTML = `
                <i class="ri-bug-line"></i>
                <b>${t.internetNo}</b>
                <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong>${t.status}</strong></p>
                <small>${t.email}</small>
            `;
            ticketList.appendChild(card);
        });
}

/* Filters */
statusFilter.onchange = () => showToast("‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß");
searchInput.oninput = () => renderTickets([]);

/* Logout */
logoutBtn.onclick = () => signOut(auth);

/* Mobile Sidebar */
hamburger.onclick = () => {
    sidebar.classList.add("show");
    sidebarOverlay.classList.add("show");
};
sidebarOverlay.onclick = () => {
    sidebar.classList.remove("show");
    sidebarOverlay.classList.remove("show");
};
</script>

</body>
</html>
