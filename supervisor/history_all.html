<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - Supervisor</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SUPERVISOR</div>
        <div class="sidebar-menu">
            <a href="main.html">üì• <span>‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span></a>
            <a href="history_all.html" class="active">üìä <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar"><span id="supEmail" style="font-weight: 600;"></span></div>
        <div class="container">
            <div class="card">
                <h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                
                <div class="view-filter">
                    <button id="viewAllBtn" class="filter-btn active">üåê ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Closed)</button>
                    <button id="viewMineBtn" class="filter-btn">üë§ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" class="input-field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet..." style="margin:0;">
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                                <th>Sale ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>Supervisor ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="6" style="text-align:center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentView = 'all'; 
        let currentSupEmail = "";

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
            } else {
                currentSupEmail = user.email;
                document.getElementById('supEmail').innerText = currentSupEmail;
                loadHistory();
            }
        });

        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            const searchText = document.getElementById('searchInput').value;
            const ticketsRef = collection(db, "tickets");
            let q;

            if (currentView === 'all') {
                // ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Closed ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                q = query(ticketsRef, where("status", "==", "Closed"), orderBy("updatedAt", "desc"));
            } else {
                // ‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Supervisor ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏≥ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå processedBy)
                q = query(
                    ticketsRef, 
                    where("processedBy", "==", currentSupEmail),
                    where("status", "==", "Closed"),
                    orderBy("updatedAt", "desc")
                );
            }

            onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const t = docSnap.data();
                    if (searchText && !t.internetNo.includes(searchText)) return;

                    const date = t.updatedAt?.toDate().toLocaleDateString('th-TH') || '-';
                    
                    html += `<tr>
                        <td><small>${date}</small></td>
                        <td><b>${t.internetNo}</b></td>
                        <td><small>${t.email}</small></td>
                        <td><small>${t.processedBy || '-'}</small></td>
                        <td><span class="status-badge bg-closed">Closed</span></td>
                        <td style="color:#059669; font-size:0.85rem;">${t.comment || '-'}</td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>';
            }, (error) => {
                console.error(error);
                if (error.code === 'failed-precondition') {
                    tbody.innerHTML = '<tr><td colspan="6" style="color:red; text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firebase Console (‡∏Å‡∏î F12 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏•‡∏¥‡∏á‡∏Å‡πå)</td></tr>';
                }
            });
        }

        document.getElementById('viewAllBtn').onclick = () => {
            currentView = 'all';
            document.getElementById('viewAllBtn').classList.add('active');
            document.getElementById('viewMineBtn').classList.remove('active');
            loadHistory();
        };

        document.getElementById('viewMineBtn').onclick = () => {
            currentView = 'mine';
            document.getElementById('viewMineBtn').classList.add('active');
            document.getElementById('viewAllBtn').classList.remove('active');
            loadHistory();
        };

        document.getElementById('searchInput').oninput = () => loadHistory();
        document.getElementById('logoutBtn').onclick = (e) => {
            e.preventDefault();
            signOut(auth).then(() => window.location.href = "../index.html");
        };
    </script>
</body>
</html>
