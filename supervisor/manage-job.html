<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Case - Supervisor</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <nav>
        <div class="nav-links">
            <a href="main.html" style="text-decoration: none; color: #4B5563; font-weight: 600;">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</a>
        </div>
    </nav>

    <div class="container" style="max-width: 700px;">
        <h2 style="color: var(--primary-green); margin-bottom: 25px;">üõ†Ô∏è ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (Action)</h2>
        
        <div id="jobDetailBox" style="background: #F3F4F6; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #E5E7EB;">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...
        </div>

        <form id="actionForm">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô:</label>
                <select id="statusSelect" class="input-field" style="height: 45px; font-size: 1rem;">
                    <option value="Open">üî¥ Open (‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß)</option>
                    <option value="In Progress">üü° In Progress (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</option>
                    <option value="Closed">üü¢ Closed (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</option>
                </select>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á Sale (Comment):</label>
                <textarea id="supComment" class="input-field" rows="6" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Sale ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠..."></textarea>
            </div>

            <div style="display: flex; gap: 15px;">
                <button type="submit" class="btn btn-primary" id="saveBtn" style="flex: 2; height: 50px; font-size: 1.1rem;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                <button type="button" class="btn btn-outline" onclick="location.href='main.html'" style="flex: 1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </form>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ticketId = localStorage.getItem('currentTicketId');

    async function loadJobData() {
        if(!ticketId) { window.location.href = 'main.html'; return; }
        
        const docRef = doc(db, "tickets", ticketId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('jobDetailBox').innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><small style="color:#6B7280;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</small><br><b>${data.internetNo}</b></div>
                    <div><small style="color:#6B7280;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</small><br><b>${data.issueType}</b></div>
                    <div style="grid-column: span 2;"><small style="color:#6B7280;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å Sale</small><br><div style="background:white; padding:10px; border-radius:6px; margin-top:5px; border:1px solid #ddd;">${data.details}</div></div>
                    <div style="grid-column: span 2;"><small style="color:#6B7280;">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</small><br><b>${data.email}</b></div>
                </div>
            `;
            document.getElementById('statusSelect').value = data.status;
            document.getElementById('supComment').value = data.comment || "";
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) loadJobData();
        else window.location.href = "../index.html";
    });

    document.getElementById('actionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerText = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        try {
            const docRef = doc(db, "tickets", ticketId);
            await updateDoc(docRef, {
                status: document.getElementById('statusSelect').value,
                comment: document.getElementById('supComment').value,
                updatedAt: serverTimestamp(),
                processedBy: auth.currentUser.email
            });
            alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            window.location.href = 'main.html';
        } catch (err) {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            saveBtn.disabled = false;
            saveBtn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï";
        }
    });
</script>
</body>
</html>
