<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 25px; }
        
        .notif-wrapper { position: relative; cursor: pointer; margin-right: 15px; }
        .notif-icon { font-size: 22px; color: #64748b; }
        .notif-badge-icon {
            position: absolute; top: -5px; right: -8px;
            background: #10B981; color: white; border-radius: 50%;
            padding: 2px 6px; font-size: 10px; font-weight: bold; display: none;
        }

        .notif-dropdown {
            position: absolute; top: 40px; right: 0; width: 300px;
            background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; z-index: 1000; display: none; overflow: hidden;
        }
        .notif-header { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-weight: 600; background: #f8fafc; }
        .notif-item { 
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 3px; text-align: left;
        }
        .notif-item:hover { background: #f0fdf4; border-left: 4px solid #10B981; }
        .notif-item b { font-size: 13px; color: #1e293b; }
        .notif-item span { font-size: 12px; color: #4b5563; }

        .shake { animation: shake-animation 0.5s ease-in-out; }
        @keyframes shake-animation {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(15deg); }
            40%, 80% { transform: rotate(-15deg); }
        }

        /* Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        /* ---------------------------------- */

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 20px; }
        .menu-card {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            text-decoration: none; color: #111827; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
        }
        .menu-card:hover { transform: translateY(-5px); border-color: #10B981; }
        .menu-card-icon { font-size: 3rem; display: block; margin-bottom: 15px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { padding: 20px; border-radius: 12px; color: white; text-align: center; }
        .stat-number { font-size: 1.8rem; font-weight: 600; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
            <a href="ticket.html">üìù <span>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span></a>
            <a href="history.html">üîç <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 style="margin:0;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
            <div style="display: flex; align-items: center;">
                <div class="notif-wrapper" id="notifBell">
                    <span class="notif-icon">üîî</span>
                    <span class="notif-badge-icon" id="notifCount">0</span>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="notif-header">üì¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                        <div id="notifList">
                            <div style="padding: 20px; text-align: center; color: #94a3b8; font-size: 13px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                        </div>
                    </div>
                </div>
                <span id="userEmail" style="font-weight: 600; color: #6B7280;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>

        <div class="container">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, Sale Support</h2>
            <p style="color: #6B7280; margin-bottom: 30px;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

            <div class="stat-grid">
                <div class="stat-box" style="background: #3B82F6;">
                    <small>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    <div id="countAll" class="stat-number">0</div>
                </div>
                <div class="stat-box" style="background: #EF4444;">
                    <small>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</small>
                    <div id="countOpen" class="stat-number">0</div>
                </div>
                <div class="stat-box" style="background: #10B981;">
                    <small>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</small>
                    <div id="countClosed" class="stat-number">0</div>
                </div>
            </div>

            <div class="menu-grid">
                <a href="ticket.html" class="menu-card">
                    <span class="menu-card-icon">üìù</span>
                    <b>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</b>
                    <p style="font-size: 0.9rem; color: #666;">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Internet ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                </a>
                <a href="history.html" class="menu-card">
                    <span class="menu-card-icon">üîç</span>
                    <b>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</b>
                    <p style="font-size: 0.9rem; color: #666;">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Supervisor</p>
                </a>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" style="margin-top:20px; line-height: 1.6;">
                </div>
            <button onclick="closeModal()" class="btn btn-primary" style="width:100%; margin-top:20px; background:#10B981; border:none; padding:10px; color:white; border-radius:8px; cursor:pointer;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown
        const bell = document.getElementById('notifBell');
        const dropdown = document.getElementById('notifDropdown');
        bell.onclick = (e) => { e.stopPropagation(); dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block'; };
        window.onclick = () => dropdown.style.display = 'none';

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
            } else {
                document.getElementById('userEmail').innerText = user.email;
                fetchStats(user.email);
                watchUserNotifications(user.email);
            }
        });

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        function fetchStats(email) {
            const q = query(collection(db, "tickets"), where("email", "==", email));
            onSnapshot(q, (snap) => {
                let all = snap.size;
                let open = 0;
                let closed = 0;
                snap.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'Closed') closed++;
                    else open++;
                });
                document.getElementById('countAll').innerText = all;
                document.getElementById('countOpen').innerText = open;
                document.getElementById('countClosed').innerText = closed;
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (New!)
        function watchUserNotifications(email) {
            // ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô In Progress ‡∏´‡∏£‡∏∑‡∏≠ Closed
            const q = query(
                collection(db, "tickets"), 
                where("email", "==", email),
                where("status", "in", ["In Progress", "Closed"]),
                orderBy("updatedAt", "desc"),
                limit(5)
            );

            let isFirstLoad = true;

            onSnapshot(q, (snap) => {
                const badge = document.getElementById('notifCount');
                const list = document.getElementById('notifList');

                if (!snap.empty) {
                    badge.innerText = snap.size;
                    badge.style.display = 'block';

                    let html = '';
                    snap.forEach(docSnap => {
                        const d = docSnap.data();
                        html += `
                            <div class="notif-item" onclick="viewTicketDetail('${docSnap.id}')">
                                <b>‚úÖ ‡∏á‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${d.internetNo}</b>
                                <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <mark style="background:#dcfce7;">${d.status}</mark></span>
                                <small>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${d.updatedAt?.toDate().toLocaleString('th-TH')}</small>
                            </div>`;
                    });
                    list.innerHTML = html;

                    if (!isFirstLoad) {
                        bell.classList.add('shake');
                        setTimeout(() => bell.classList.remove('shake'), 500);
                        new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
                    }
                }
                isFirstLoad = false;
            });
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
        window.viewTicketDetail = async (id) => {
            const docSnap = await getDoc(doc(db, "tickets", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                document.getElementById('modalTitle').innerText = "‡∏á‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: " + d.internetNo;
                document.getElementById('modalBody').innerHTML = `
                    <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> <span class="status-badge ${d.status === 'Closed' ? 'bg-closed' : 'bg-process'}">${d.status}</span></p>
                    <p><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</b> ${d.topic || d.issueType}</p>
                    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                    <p><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Admin/Sup:</b></p>
                    <div style="background:#f9fafb; padding:15px; border-radius:8px; border-left:4px solid #10B981; font-style:italic;">
                        ${d.supNote || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"}
                    </div>
                    <p style="font-size:11px; color:#999; margin-top:10px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢: ${d.processedBy || '‡∏£‡∏∞‡∏ö‡∏ö'}</p>
                `;
                document.getElementById('viewModal').style.display = 'block';
                dropdown.style.display = 'none';
            }
        };

        window.closeModal = () => { document.getElementById('viewModal').style.display = 'none'; };

        // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        document.getElementById('logoutBtn').onclick = (e) => {
            e.preventDefault();
            signOut(auth).then(() => window.location.href = "../index.html");
        };
    </script>
</body>
</html>
