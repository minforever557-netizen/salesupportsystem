<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Portal - Sale Support System</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin/Supervisor */
        .main-content { padding: 20px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 992px) { .grid-layout { grid-template-columns: 1fr; } }
        
        .ticket-item { 
            border-bottom: 1px solid #f1f5f9; padding: 15px 0; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .ticket-item:last-child { border-bottom: none; }
        .time-label { font-size: 11px; color: #94a3b8; display: block; margin-top: 4px; }
        .note-preview { 
            font-size: 13px; color: #475569; background: #f8fafc; 
            padding: 8px; border-radius: 6px; margin-top: 5px; border-left: 3px solid #e2e8f0;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üìù <span>‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</span></a>
            <a href="history.html">üìú <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <span style="font-weight: 600; color: #1e293b;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <span id="userEmailDisplay">...</span></span>
        </div>

        <div class="container">
            <div class="grid-layout">
                
                <div class="card">
                    <h3 style="margin-top:0;">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                    <form id="ticketForm">
                        <div class="form-group">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet (88/NF)</label>
                            <input type="text" id="internetNo" class="input-field" placeholder="88xxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>
                            <select id="issueTopic" class="input-field" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="detail" class="input-field" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                        </div>
                        <button type="submit" id="submitBtn" class="btn-login" style="background:#10b981; width:100%;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</button>
                    </form>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">üïí ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <a href="history.html" style="font-size:13px; color:#10b981; text-decoration:none;">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
                    </div>
                    <div id="recentTicketsList">
                        <p style="text-align:center; padding:20px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            currentUser = user;
            document.getElementById('userEmailDisplay').innerText = user.email;
            loadIssueOptions();
            loadRecentTickets();
        }
    });

    // ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å Settings (Format ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin)
    async function loadIssueOptions() {
        const docSnap = await getDoc(doc(db, "settings", "issueOptions"));
        if (docSnap.exists()) {
            const options = docSnap.data().options || [];
            const select = document.getElementById('issueTopic');
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt; el.textContent = opt;
                select.appendChild(el);
            });
        }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Ticket ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° TimeStamp
    document.getElementById('ticketForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

        try {
            await addDoc(collection(db, "tickets"), {
                internetNo: document.getElementById('internetNo').value,
                topic: document.getElementById('issueTopic').value,
                detail: document.getElementById('detail').value,
                email: currentUser.email,
                uid: currentUser.uid,
                status: "Open",
                supNote: "",
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            document.getElementById('ticketForm').reset();
        } catch (error) { alert("Error: " + error.message); }
        finally { btn.disabled = false; btn.innerText = "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô"; }
    };

    // ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function loadRecentTickets() {
        const q = query(
            collection(db, "tickets"),
            where("uid", "==", currentUser.uid),
            orderBy("createdAt", "desc"),
            limit(5)
        );

        onSnapshot(q, (snap) => {
            const listDiv = document.getElementById('recentTicketsList');
            let html = '';
            snap.forEach(docSnap => {
                const t = docSnap.data();
                const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process');
                const updateTime = t.updatedAt ? t.updatedAt.toDate().toLocaleString('th-TH') : '-';

                html += `
                    <div class="ticket-item">
                        <div style="flex:1;">
                            <b>${t.internetNo}</b> <span class="status-badge ${statusClass}" style="font-size:10px; padding:2px 8px;">${t.status}</span>
                            <div style="font-size:13px; color:#64748b; margin-top:3px;">${t.topic}</div>
                            ${t.supNote ? `<div class="note-preview">üí¨ ${t.supNote}</div>` : ''}
                            <span class="time-label">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${updateTime}</span>
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html || '<p style="text-align:center; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</p>';
        });
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
