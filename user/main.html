<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ */
        .notif-header { 
            padding: 12px 15px; 
            border-bottom: 1px solid #f1f5f9; 
            font-weight: 600; 
            background: #f8fafc; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .read-all-btn {
            font-size: 11px;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .read-all-btn:hover { background: #2563eb; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°... */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 25px; }
        .notif-wrapper { position: relative; cursor: pointer; margin-right: 15px; }
        .notif-icon { font-size: 22px; color: #64748b; }
        .notif-badge-icon {
            position: absolute; top: -5px; right: -8px;
            background: #10B981; color: white; border-radius: 50%;
            padding: 2px 6px; font-size: 10px; font-weight: bold; display: none;
        }
        .notif-dropdown {
            position: absolute; top: 40px; right: 0; width: 300px;
            background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; z-index: 1000; display: none; overflow: hidden;
        }
        .notif-item { 
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 3px; text-align: left;
        }
        .notif-item:hover { background: #f0fdf4; border-left: 4px solid #10B981; }
        .shake { animation: shake-animation 0.5s ease-in-out; }
        @keyframes shake-animation {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(15deg); }
            40%, 80% { transform: rotate(-15deg); }
        }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { padding: 20px; border-radius: 12px; color: white; text-align: center; }
        .stat-number { font-size: 1.8rem; font-weight: 600; margin-top: 5px; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 20px; }
        .menu-card {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            text-decoration: none; color: #111827; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
            <a href="ticket.html">üìù <span>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span></a>
            <a href="history.html">üîç <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 style="margin:0;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h3>
            <div style="display: flex; align-items: center;">
                <div class="notif-wrapper" id="notifBell">
                    <span class="notif-icon">üîî</span>
                    <span class="notif-badge-icon" id="notifCount">0</span>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="notif-header">
                            <span>üì¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</span>
                            <button class="read-all-btn" id="readAllBtn">Read All</button>
                        </div>
                        <div id="notifList">
                            <div style="padding: 20px; text-align: center; color: #94a3b8; font-size: 13px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                        </div>
                    </div>
                </div>
                <span id="userEmail" style="font-weight: 600; color: #6B7280;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>

        <div class="container">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, Sale Support</h2>
            <p style="color: #6B7280; margin-bottom: 30px;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

            <div class="stat-grid">
                <div class="stat-box" style="background: #3B82F6;"><small>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><div id="countAll" class="stat-number">0</div></div>
                <div class="stat-box" style="background: #EF4444;"><small>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</small><div id="countOpen" class="stat-number">0</div></div>
                <div class="stat-box" style="background: #10B981;"><small>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</small><div id="countClosed" class="stat-number">0</div></div>
            </div>

            <div class="menu-grid">
                <a href="ticket.html" class="menu-card"><span class="menu-card-icon">üìù</span><b>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</b></a>
                <a href="history.html" class="menu-card"><span class="menu-card-icon">üîç</span><b>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</b></a>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" style="margin-top:20px; line-height: 1.6;"></div>
            <button onclick="closeModal()" class="btn btn-primary" style="width:100%; margin-top:20px; background:#10B981; border:none; padding:10px; color:white; border-radius:8px; cursor:pointer;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, getDocs, updateDoc, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isInitialLoad = true;

        // UI Dropdown
        const bell = document.getElementById('notifBell');
        const dropdown = document.getElementById('notifDropdown');
        bell.onclick = (e) => { e.stopPropagation(); dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block'; };
        window.onclick = () => dropdown.style.display = 'none';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('userEmail').innerText = user.email;
                fetchStats(user.email);
                watchStatusChanges(user.email);
                if ("Notification" in window) Notification.requestPermission();
            } else {
                window.location.href = "../index.html";
            }
        });

        // 1. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        function fetchStats(email) {
            const q = query(collection(db, "tickets"), where("email", "==", email));
            onSnapshot(q, (snap) => {
                let all = snap.size, open = 0, closed = 0;
                snap.forEach(doc => {
                    const s = doc.data().status;
                    if (s === 'Closed') closed++; else open++;
                });
                document.getElementById('countAll').innerText = all;
                document.getElementById('countOpen').innerText = open;
                document.getElementById('countClosed').innerText = closed;
            });
        }

        // 2. ‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô" (isReadSale != true)
        function watchStatusChanges(email) {
            const q = query(
                collection(db, "tickets"), 
                where("email", "==", email),
                where("status", "in", ["In Progress", "Closed"]),
                where("isReadSale", "!=", true) 
            );

            onSnapshot(q, (snap) => {
                const badge = document.getElementById('notifCount');
                const list = document.getElementById('notifList');

                if (!snap.empty) {
                    badge.innerText = snap.size;
                    badge.style.display = 'block';

                    let html = '';
                    snap.forEach(docSnap => {
                        const d = docSnap.data();
                        const color = d.status === 'Closed' ? '#10B981' : '#F59E0B';
                        html += `
                            <div class="notif-item" onclick="viewAndMarkRead('${docSnap.id}')">
                                <b>‚úÖ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${d.internetNo}</b>
                                <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b style="color:${color}">${d.status}</b></span>
                                <small>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${d.updatedAt?.toDate().toLocaleString('th-TH')}</small>
                            </div>`;
                    });
                    list.innerHTML = html;

                    if (!isInitialLoad) {
                        bell.classList.add('shake');
                        setTimeout(() => bell.classList.remove('shake'), 500);
                        new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
                        
                        // Browser Push Notification
                        if (Notification.permission === "granted") {
                            new Notification("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô!", { body: "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard" });
                        }
                    }
                } else {
                    badge.style.display = 'none';
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>';
                }
                isInitialLoad = false;
            });
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ + ‡πÄ‡∏õ‡∏¥‡∏î Modal)
        window.viewAndMarkRead = async (id) => {
            await updateDoc(doc(db, "tickets", id), { isReadSale: true });
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal
            const docSnap = await getDoc(doc(db, "tickets", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                document.getElementById('modalTitle').innerText = "‡∏á‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: " + d.internetNo;
                document.getElementById('modalBody').innerHTML = `
                    <p><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${d.status}</p>
                    <p><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b></p>
                    <div style="background:#f3f4f6; padding:10px; border-radius:8px;">${d.supNote || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'}</div>
                `;
                document.getElementById('viewModal').style.display = 'block';
                dropdown.style.display = 'none';
            }
        };

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Read All (‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
        document.getElementById('readAllBtn').onclick = async (e) => {
            e.stopPropagation();
            const userEmail = auth.currentUser.email;
            const q = query(
                collection(db, "tickets"), 
                where("email", "==", userEmail),
                where("isReadSale", "!=", true),
                where("status", "in", ["In Progress", "Closed"])
            );

            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) return;

            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.update(doc.ref, { isReadSale: true });
            });

            await batch.commit();
            dropdown.style.display = 'none';
        };

        window.closeModal = () => { document.getElementById('viewModal').style.display = 'none'; };
        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
    </script>
</body>
</html>
