<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Sale Support System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global CSS (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤) -->
    <link rel="stylesheet" href="../style.css">
</head>

<body>

<!-- ================= MOBILE OVERLAY ================= -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>

<!-- ================= DASHBOARD LAYOUT ================= -->
<div class="dashboard-layout">

    <!-- ================= SIDEBAR ================= -->
    <aside id="sidebar" class="dashboard-sidebar">
        <h2>SALE PORTAL</h2>

        <nav class="dashboard-nav">
            <a href="main.html" class="active">üè† Dashboard</a>
            <a href="create-ticket.html">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a>
            <a href="history.html">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</a>
            <a href="#" id="logoutBtn" class="dashboard-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </nav>
    </aside>

    <!-- ================= MAIN ================= -->
    <main class="dashboard-main">

        <!-- ===== TOP BAR ===== -->
        <div class="dashboard-top">
            <button id="hamburger" class="hamburger">‚ò∞</button>

            <div class="dashboard-user">
                <b id="userEmail">Loading...</b><br>
                <small>User</small>
            </div>
        </div>

        <!-- ===== STATS ===== -->
        <section class="dashboard-stats">
            <div class="stat-card">
                <small>Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                <h2 id="countAll">0</h2>
            </div>

            <div class="stat-card">
                <small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</small>
                <h2 id="countOpen">0</h2>
            </div>

            <div class="stat-card">
                <small>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</small>
                <h2 id="countClosed">0</h2>
            </div>
        </section>

        <!-- ===== QUICK MENU ===== -->
        <section class="dashboard-menu">

            <a href="create-ticket.html" class="menu-tile">
                <div class="menu-icon">üìù</div>
                <b>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</b>
                <p>‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            </a>

            <a href="history.html" class="menu-tile">
                <div class="menu-icon">üìÇ</div>
                <b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</b>
                <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </a>

        </section>

    </main>
</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
/* ================= FIREBASE IMPORT ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
    apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
    authDomain: "sale-support-system.firebaseapp.com",
    projectId: "sale-support-system",
    storageBucket: "sale-support-system.firebasestorage.app",
    messagingSenderId: "640337786680",
    appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
};

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= AUTH GUARD ================= */
onAuthStateChanged(auth, (user) => {
    if (!user) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà Login ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ index
        window.location.href = "../index.html";
        return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á email user ‡∏à‡∏£‡∏¥‡∏á
    userEmail.innerText = user.email;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Ticket
    loadTicketStats(user.email);
});

/* ================= LOAD STATS ================= */
function loadTicketStats(email) {

    const q = query(
        collection(db, "tickets"),
        where("email", "==", email)
    );

    onSnapshot(q, (snap) => {
        let open = 0;
        let closed = 0;

        snap.forEach(doc => {
            doc.data().status === "Closed" ? closed++ : open++;
        });

        countAll.innerText = snap.size;
        countOpen.innerText = open;
        countClosed.innerText = closed;
    });
}

/* ================= LOGOUT ================= */
logoutBtn.onclick = () => {
    signOut(auth);
};

/* ================= MOBILE SIDEBAR ================= */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("sidebarOverlay");
const hamburger = document.getElementById("hamburger");

hamburger.onclick = () => {
    sidebar.classList.add("show");
    overlay.classList.add("show");
};

overlay.onclick = () => {
    sidebar.classList.remove("show");
    overlay.classList.remove("show");
};
</script>

</body>
</html>
