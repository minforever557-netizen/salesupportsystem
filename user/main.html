<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Sale Support System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
</head>

<body class="dashboard-body">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">SALE PORTAL</div>

    <nav class="sidebar-menu">
        <a href="main.html" class="active">üè† <span>Dashboard</span></a>
        <a href="ticket.html">üìù <span>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span></a>
        <a href="history.html">üîç <span>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>

        <div class="sidebar-footer">
            <hr class="sidebar-divider">
            <a href="#" id="logoutBtn" class="logout-link">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </nav>
</aside>

<!-- ================= MAIN ================= -->
<main class="main-content">

    <!-- ================= TOP BAR ================= -->
    <header class="top-bar">

        <!-- Hamburger (Mobile) -->
        <button id="menuToggle" class="btn" style="width:auto;padding:8px 12px;display:none">
            ‚ò∞
        </button>

        <h3 class="page-title">Dashboard</h3>

        <div class="user-info">
            <div id="userEmail" class="user-email">Loading...</div>
            <small class="user-role">Sale Representative</small>
        </div>
    </header>

    <!-- ================= WELCOME ================= -->
    <section class="card" style="margin-bottom:24px">
        <div style="font-size:1.1rem;font-weight:600;color:var(--green-dark)">
            üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
        </div>
        <div style="color:var(--text-muted);margin-top:4px">
            ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        </div>
    </section>

    <!-- ================= STATS ================= -->
    <section class="stat-grid">
        <div class="stat-box stat-blue">
            <small>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            <div id="countAll" class="stat-number">0</div>
        </div>

        <div class="stat-box stat-red">
            <small>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</small>
            <div id="countOpen" class="stat-number">0</div>
        </div>

        <div class="stat-box stat-green">
            <small>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</small>
            <div id="countClosed" class="stat-number">0</div>
        </div>
    </section>

    <!-- ================= QUICK MENU ================= -->
    <section class="menu-grid">
        <a href="ticket.html" class="menu-card">
            <div class="menu-icon">üìù</div>
            <b>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</b>
            <p>‡∏™‡πà‡∏á Ticket ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
        </a>

        <a href="history.html" class="menu-card">
            <div class="menu-icon">üîç</div>
            <b>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</b>
            <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
        </a>
    </section>

    <!-- ================= RECENT ================= -->
    <section class="card" style="margin-top:28px">
        <h4 style="margin-top:0">üïí ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
        <div id="recentTickets" class="text-muted">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>

        <div style="margin-top:12px">
            <a href="history.html" class="link">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
        </div>
    </section>

</main>

<!-- ================= SCRIPT ================= -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, user => {
        if (!user) {
            window.location.href = "../index.html";
            return;
        }
        userEmail.innerText = user.email;
        loadStats(user.email);
    });

    function loadStats(email){
        const q = query(collection(db,"tickets"), where("email","==",email));
        onSnapshot(q, snap => {
            let open = 0, closed = 0;
            snap.forEach(d => d.data().status === "Closed" ? closed++ : open++);
            countAll.innerText = snap.size;
            countOpen.innerText = open;
            countClosed.innerText = closed;
        });
    }

    logoutBtn.onclick = () => signOut(auth);

    // ================= HAMBURGER =================
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");

    function handleResize(){
        if (window.innerWidth <= 768) {
            sidebar.style.display = "none";
            menuToggle.style.display = "block";
        } else {
            sidebar.style.display = "flex";
            menuToggle.style.display = "none";
        }
    }

    menuToggle.onclick = () => {
        sidebar.style.display = sidebar.style.display === "none" ? "flex" : "none";
    };

    window.addEventListener("resize", handleResize);
    handleResize();
</script>

</body>
</html>
