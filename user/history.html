<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .history-container { max-width: 1000px; margin: 30px auto; width: 95%; }
        .status-card {
            background: white; border-radius: 12px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr auto; gap: 15px;
            border-left: 5px solid #d1d5db; transition: 0.3s;
        }
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        /* ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .border-open { border-left-color: #ef4444; }
        .border-process { border-left-color: #f59e0b; }
        .border-closed { border-left-color: #10b981; }
        
        .update-tag { font-size: 11px; color: #94a3b8; margin-top: 5px; display: block; }
        .note-box { background: #f8fafc; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 10px; color: #475569; }
    </style>
</head>
<body style="background: #f1f5f9;">

    <div class="history-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="margin:0;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <a href="main.html" style="text-decoration:none; color:#10b981; font-weight:600;">+ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</a>
        </div>

        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button class="status-badge" style="cursor:pointer; border:none; background:#1e293b; color:white;" onclick="filterJobs('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="status-badge bg-open" style="cursor:pointer; border:none;" onclick="filterJobs('Open')">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
            <button class="status-badge bg-process" style="cursor:pointer; border:none;" onclick="filterJobs('In Progress')">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
            <button class="status-badge bg-closed" style="cursor:pointer; border:none;" onclick="filterJobs('Closed')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        </div>

        <div id="historyList">
            <p style="text-align:center; padding:50px; color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allTickets = [];

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else fetchHistory(user.uid);
    });

    function fetchHistory(uid) {
        // Query ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const q = query(
            collection(db, "tickets"),
            where("uid", "==", uid),
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snap) => {
            allTickets = [];
            snap.forEach(doc => allTickets.push({id: doc.id, ...doc.data()}));
            renderTickets(allTickets);
        });
    }

    window.renderTickets = (tickets) => {
        const listDiv = document.getElementById('historyList');
        if (tickets.length === 0) {
            listDiv.innerHTML = '<div class="card" style="text-align:center; color:#94a3b8;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô</div>';
            return;
        }

        listDiv.innerHTML = tickets.map(t => {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const borderClass = t.status === 'Open' ? 'border-open' : (t.status === 'Closed' ? 'border-closed' : 'border-process');
            const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process');
            
            // ‡πÅ‡∏õ‡∏•‡∏á Time Stamp ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            const createTime = t.createdAt ? t.createdAt.toDate().toLocaleString('th-TH', {dateStyle:'medium', timeStyle:'short'}) : '-';
            const updateTime = t.updatedAt ? t.updatedAt.toDate().toLocaleString('th-TH', {dateStyle:'medium', timeStyle:'short'}) : '-';

            return `
                <div class="status-card ${borderClass}">
                    <div>
                        <div style="font-size: 14px; color: #64748b;">‡πÄ‡∏•‡∏Ç‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï: <b style="color:#1e293b; font-size:16px;">${t.internetNo}</b></div>
                        <div style="font-weight: 600; margin-top: 5px;">${t.topic}</div>
                        <small style="color:#94a3b8;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${t.detail || '-'}</small>
                        
                        ${t.supNote ? `<div class="note-box"><b>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:</b><br>${t.supNote}</div>` : ''}
                        
                        <span class="update-tag">üïí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createTime} | üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${updateTime}</span>
                    </div>
                    <div style="text-align: right;">
                        <span class="status-badge ${statusClass}">${t.status}</span>
                    </div>
                </div>
            `;
        }).join('');
    };

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Filter)
    window.filterJobs = (status) => {
        if (status === 'all') renderTickets(allTickets);
        else {
            const filtered = allTickets.filter(t => t.status === status);
            renderTickets(filtered);
        }
    };
</script>
</body>
</html>
