<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html">üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
            <a href="ticket.html">üìù <span>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span></a>
            <a href="history.html" class="active">üîç <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="flex: 1; font-weight: 600; color: var(--primary-green);">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</div>
            <span id="userEmail" style="font-weight: 600; color: var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>

        <div class="container">
            <div class="card">
                <h3>üîç ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3>
                
                <div class="view-filter" style="display: flex; gap: 10px; margin-bottom: 20px; background: #f1f5f9; padding: 10px; border-radius: 12px;">
                    <button id="viewAllBtn" class="filter-btn active" style="flex:1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;">üåê ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button id="viewMineBtn" class="filter-btn" style="flex:1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;">üë§ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted);">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</label>
                    <div style="position: relative;">
                        <input type="text" id="searchInput" class="input-field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="padding-left: 40px;">
                        <span style="position: absolute; left: 15px; top: 12px; color: var(--text-muted);">üîç</span>
                    </div>
                </div>
                
                <div class="table-container" style="overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>Internet No.</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Supervisor</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentView = 'all';
        let currentUserEmail = "";

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
            } else {
                currentUserEmail = user.email;
                document.getElementById('userEmail').innerText = user.email;
                loadHistory();
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time
        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            const searchText = document.getElementById('searchInput').value.trim();
            let q;
            const ticketsRef = collection(db, "tickets");

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Query ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (currentView === 'all') {
                q = query(ticketsRef, orderBy("createdAt", "desc"));
            } else {
                q = query(ticketsRef, where("email", "==", currentUserEmail), orderBy("createdAt", "desc"));
            }

            onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 30px;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const t = docSnap.data();
                    
                    // Filter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç Internet (Client-side search)
                    if (searchText && !t.internetNo.includes(searchText)) return;

                    const date = t.createdAt?.toDate().toLocaleDateString('th-TH', { 
                        day:'2-digit', month:'short', year:'2-digit' 
                    }) || '-';
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å style.css)
                    const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'In Progress' ? 'bg-process' : 'bg-closed');

                    html += `<tr>
                        <td><small>${date}</small></td>
                        <td><small style="color: var(--text-muted);">${t.email.split('@')[0]}</small></td>
                        <td><b style="color: var(--text-main);">${t.internetNo}</b></td>
                        <td>${t.issueType}</td>
                        <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                        <td style="font-size: 0.85rem; color: var(--dark-green); max-width: 200px;">${t.supNote || t.comment || '-'}</td>
                    </tr>`;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding: 30px;">üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</td></tr>';
            });
        }

        // Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Filter
        const allBtn = document.getElementById('viewAllBtn');
        const mineBtn = document.getElementById('viewMineBtn');

        function updateBtnStyles() {
            if (currentView === 'all') {
                allBtn.style.background = 'var(--primary-green)';
                allBtn.style.color = 'white';
                mineBtn.style.background = 'white';
                mineBtn.style.color = 'var(--text-muted)';
            } else {
                mineBtn.style.background = 'var(--primary-green)';
                mineBtn.style.color = 'white';
                allBtn.style.background = 'white';
                allBtn.style.color = 'var(--text-muted)';
            }
        }

        allBtn.onclick = () => { currentView = 'all'; updateBtnStyles(); loadHistory(); };
        mineBtn.onclick = () => { currentView = 'mine'; updateBtnStyles(); loadHistory(); };
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå
        document.getElementById('searchInput').oninput = () => loadHistory();

        // Logout
        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
        
        // Initial Style
        updateBtnStyles();
    </script>
</body>
</html>
