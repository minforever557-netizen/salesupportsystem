<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Ticket</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../style.css">

<style>
.controls {
    display: flex;
    gap: 12px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.controls select,
.controls input {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 14px;
}

.ticket-list {
    display: grid;
    gap: 16px;
}

.ticket-card {
    background: #fff;
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: transform .15s ease;
}

.ticket-card:hover {
    transform: translateY(-2px);
}

.ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ticket-id {
    font-weight: 700;
}

.ticket-date {
    font-size: 13px;
    color: var(--text-muted);
}

.badge {
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 12px;
    color: white;
    font-weight: 600;
}

.open { background:#22c55e; }
.progress { background:#f59e0b; }
.closed { background:#ef4444; }

/* ===== MODAL ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal.show { display: flex; }

.modal-box {
    background: white;
    border-radius: 18px;
    max-width: 420px;
    width: 90%;
    padding: 22px;
    animation: pop .25s ease;
}

@keyframes pop {
    from { transform: scale(.9); opacity:0 }
    to { transform: scale(1); opacity:1 }
}

.modal-box h3 {
    margin-bottom: 12px;
}
</style>
</head>

<body>

<div class="dashboard-layout">

<aside class="dashboard-sidebar">
    <h2>SALE PORTAL</h2>
    <nav class="dashboard-nav">
        <a href="main.html">üè† Dashboard</a>
        <a href="create-ticket.html">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a>
        <a href="history.html" class="active">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
        <a href="#" id="logoutBtn" class="dashboard-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </nav>
</aside>

<main class="dashboard-main">
    <h1>üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h1>

    <div class="controls">
        <select id="statusFilter">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Closed">Closed</option>
        </select>

        <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Internet No">
    </div>

    <div id="ticketList" class="ticket-list"></div>
</main>

</div>

<!-- ===== MODAL ===== -->
<div id="modal" class="modal">
    <div class="modal-box">
        <h3 id="mInternet"></h3>
        <p><b>Status:</b> <span id="mStatus"></span></p>
        <p><b>Category:</b> <span id="mCategory"></span></p>
        <p><b>Detail:</b><br><span id="mDetail"></span></p>
        <p class="ticket-date" id="mDate"></p>
        <button class="btn-primary" onclick="modal.classList.remove('show')">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
  authDomain: "sale-support-system.firebaseapp.com",
  projectId: "sale-support-system"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ticketList = document.getElementById("ticketList");
let allTickets = [];

/* ===== Auth ===== */
onAuthStateChanged(auth, user => {
    if (!user) return location.href = "../index.html";

    const q = query(
        collection(db, "tickets"),
        where("email", "==", user.email),
        orderBy("createdAt", "desc")
    );

    onSnapshot(q, snap => {
        allTickets = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        render();
    });
});

/* ===== Render ===== */
function render() {
    const status = statusFilter.value;
    const search = searchInput.value.toLowerCase();

    ticketList.innerHTML = "";

    allTickets
        .filter(t =>
            (!status || t.status === status) &&
            t.internetNo.toLowerCase().includes(search)
        )
        .forEach(t => {
            const badge =
              t.status === "Closed" ? "closed" :
              t.status === "In Progress" ? "progress" : "open";

            const date = t.createdAt?.toDate().toLocaleString("th-TH");

            const div = document.createElement("div");
            div.className = "ticket-card";
            div.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-id">${t.internetNo}</div>
                    <span class="badge ${badge}">${t.status}</span>
                </div>
                <p class="ticket-date">${date}</p>
            `;

            div.onclick = () => openModal(t, date);
            ticketList.appendChild(div);
        });
}

/* ===== Modal ===== */
window.openModal = (t, date) => {
    modal.classList.add("show");
    mInternet.innerText = t.internetNo;
    mStatus.innerText = t.status;
    mCategory.innerText = t.category;
    mDetail.innerText = t.detail;
    mDate.innerText = date;
};

/* ===== Events ===== */
statusFilter.onchange = render;
searchInput.oninput = render;
logoutBtn.onclick = () => signOut(auth);
</script>

</body>
</html>
