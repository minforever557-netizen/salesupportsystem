<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô - Sale Support</title>
    <link rel="stylesheet" href="../style.css?v=1.2">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html">üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
            <a href="ticket.html">üìù <span>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span></a>
            <a href="history.html" class="active">üîç <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>
            <div style="margin-top: auto; padding: 10px;">
                <hr style="border:0; border-top:1px solid #374151; margin-bottom:15px;">
                <a href="#" id="logoutBtn" style="color: #ef4444; padding: 10px;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 style="margin:0;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3>
            <div id="userEmail" style="font-weight: 600; color: var(--text-muted);">Loading...</div>
        </div>

        <div class="container" style="max-width: 1100px;">
            <div class="card">
                <h3>üîç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
                
                <div class="view-filter">
                    <button id="viewAllBtn" class="filter-btn active">üåê ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button id="viewMineBtn" class="filter-btn">üë§ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" class="input-field" 
                           placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå Internet..." style="margin:0;">
                </div>
                
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="5" style="text-align:center; padding: 40px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; margin: 5% auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                <h3 style="margin:0; color: var(--primary-green);">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™</h3>
                <span id="closeModal" style="cursor:pointer; font-size: 24px;">&times;</span>
            </div>
            
            <div id="modalData">
                </div>
            
            <button id="closeModalBtn" class="btn-primary" style="margin-top:20px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentView = 'all'; 
        let currentUserEmail = "";

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
            } else {
                currentUserEmail = user.email;
                document.getElementById('userEmail').innerText = currentUserEmail;
                loadHistory();
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let q = currentView === 'all' 
                ? query(collection(db, "tickets"), orderBy("createdAt", "desc"))
                : query(collection(db, "tickets"), where("email", "==", currentUserEmail), orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const t = docSnap.data();
                    const id = docSnap.id;
                    
                    // Filter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå Internet
                    if (searchText && !t.internetNo.includes(searchText)) return;

                    const date = t.createdAt?.toDate().toLocaleDateString('th-TH') || '-';
                    const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'In Progress' ? 'bg-process' : 'bg-closed');

                    html += `
                        <tr class="ticket-row" data-id="${id}" style="cursor:pointer;">
                            <td><small>${date}</small></td>
                            <td><b>${t.internetNo}</b></td>
                            <td>${t.issueType}</td>
                            <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                            <td><button class="filter-btn view-btn" data-id="${id}" style="padding: 5px 10px; font-size: 12px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
                        </tr>`;
                });
                tbody.innerHTML = html;

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Module Script)
                document.querySelectorAll('.ticket-row, .view-btn').forEach(element => {
                    element.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const ticketId = element.getAttribute('data-id');
                        viewDetails(ticketId);
                    });
                });
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal
        async function viewDetails(id) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalData');
            content.innerHTML = '<p style="text-align:center;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            modal.style.display = 'block';

            try {
                const docRef = doc(db, "tickets", id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    content.innerHTML = `
                        <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-bottom:15px;">
                            <p><strong>üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Sale):</strong></p>
                            <p style="margin: 5px 0;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${data.issueType}</p>
                            <p style="margin: 5px 0;">‡πÄ‡∏ö‡∏≠‡∏£‡πå Internet: ${data.internetNo}</p>
                            <p style="margin: 10px 0; padding:10px; background:white; border-left:4px solid var(--primary-green); font-style:italic;">
                                "${data.details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}"
                            </p>
                        </div>
                        <div style="background:#ecfdf5; padding:15px; border-radius:10px; border: 1px solid #10B981;">
                            <p style="color:#065f46;"><strong>‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Supervisor):</strong></p>
                            <p style="margin: 10px 0; font-weight:600; color:#1e293b;">
                                ${data.supNote || '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô'}
                            </p>
                            <p style="font-size:12px; color:#666;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${data.status}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = '<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        }

        // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        document.getElementById('viewAllBtn').onclick = () => { currentView = 'all'; updateBtnUI(); loadHistory(); };
        document.getElementById('viewMineBtn').onclick = () => { currentView = 'mine'; updateBtnUI(); loadHistory(); };
        
        function updateBtnUI() {
            document.getElementById('viewAllBtn').classList.toggle('active', currentView === 'all');
            document.getElementById('viewMineBtn').classList.toggle('active', currentView === 'mine');
        }

        document.getElementById('searchInput').oninput = () => loadHistory();
        
        // ‡∏õ‡∏¥‡∏î Modal
        const closeModal = () => { document.getElementById('detailModal').style.display = 'none'; };
        document.getElementById('closeModal').onclick = closeModal;
        document.getElementById('closeModalBtn').onclick = closeModal;
        window.onclick = (e) => { if (e.target == document.getElementById('detailModal')) closeModal(); };

        // Logout
        document.getElementById('logoutBtn').onclick = (e) => {
            e.preventDefault();
            signOut(auth).then(() => window.location.href = "../index.html");
        };
    </script>
</body>
</html>
