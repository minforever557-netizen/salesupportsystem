<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>р╕кр╣Ир╕З Ticket р╣Гр╕лр╕бр╣И - Sale Support</title>
    <link rel="stylesheet" href="../style.css?v=1.1">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html">ЁЯПа <span>р╕лр╕Щр╣Йр╕▓р╕лр╕ер╕▒р╕Б</span></a>
            <a href="ticket.html" class="active">ЁЯУЭ <span>р╕кр╣Ир╕З Ticket р╣Гр╕лр╕бр╣И</span></a>
            <a href="history.html">ЁЯФН <span>р╕Др╣Йр╕Щр╕лр╕▓/р╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕Зр╕▓р╕Щ</span></a>
            <div style="margin-top: auto; padding: 10px;">
                <hr style="border:0; border-top:1px solid #374151; margin-bottom:15px;">
                <a href="#" id="logoutBtn" style="color: #ef4444; padding: 10px;">ЁЯЪк <span>р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</span></a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 style="margin:0;">р╣Бр╕Ир╣Йр╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕кр╕Щр╕▒р╕Ър╕кр╕Щр╕╕р╕Щ</h3>
            <div id="userEmailTop" style="font-weight: 600; color: var(--text-muted);">Loading...</div>
        </div>

        <div class="container">
            <div class="card">
    <h2 class="ticket-header">ЁЯУЭ р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╕Ир╕▒р╕Фр╕Бр╕▓р╕г Case р╣Гр╕лр╕бр╣И</h2>
    <p style="color: var(--text-muted); margin-bottom: 25px;">р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╣Йр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Чр╕╡р╕бр╕Зр╕▓р╕Щр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ</p>
    
    <form id="ticketForm">
        <label for="issueType">р╕лр╕▒р╕зр╕Вр╣Йр╕нр╕Ыр╕▒р╕Нр╕лр╕▓:</label>
        <select id="issueType" class="input-field" required>
            <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕▒р╕зр╕Вр╣Йр╕н --</option>
        </select>

        <label for="internetNo">р╕лр╕бр╕▓р╕вр╣Ар╕ер╕В Internet (10 р╕лр╕ер╕▒р╕Б):</label>
        <input type="text" id="internetNo" class="input-field" 
               placeholder="р╣Ар╕Кр╣Ир╕Щ 88XXXXXXXX" required pattern="[0-9]{10}">

        <label for="details">р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б:</label>
        <textarea id="details" class="input-field" rows="5" 
                  placeholder="р╕гр╕░р╕Ър╕╕р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Вр╕нр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓р╕лр╕гр╕╖р╕нр╕Др╕зр╕▓р╕бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г..." required></textarea>

        <button type="submit" class="btn-primary" id="submitBtn">р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ир╣Йр╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕З</button>
    </form>
</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. Firebase Configuration
        const firebaseConfig = { 
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw", 
            authDomain: "sale-support-system.firebaseapp.com", 
            projectId: "sale-support-system", 
            storageBucket: "sale-support-system.firebasestorage.app", 
            messagingSenderId: "640337786680", 
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╣Бр╕ер╕░р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б (Options)
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html"; // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╣Гр╕лр╣Йр╣Ар╕Фр╣Йр╕Зр╕Бр╕ер╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╣Бр╕гр╕Б
            } else {
                document.getElementById('userEmailTop').innerText = user.email;
                
                // р╣Вр╕лр╕ер╕Фр╕лр╕▒р╕зр╕Вр╣Йр╕нр╕Ыр╕▒р╕Нр╕лр╕▓р╕Ир╕▓р╕Б Firestore (Collection settings -> Document issueOptions)
                onSnapshot(doc(db, "settings", "issueOptions"), (snap) => {
                    if (snap.exists()) {
                        const opts = snap.data().options || [];
                        const issueSelect = document.getElementById('issueType');
                        issueSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕▒р╕зр╕Вр╣Йр╕н --</option>' + 
                            opts.map(o => `<option value="${o}">${o}</option>`).join('');
                    }
                });
            }
        });

        // 3. р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б Ticket р╣Гр╕лр╕бр╣И
        document.getElementById('ticketForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            
            // р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╕Бр╕Фр╕Лр╣Йр╕│р╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
            btn.disabled = true; 
            btn.innerText = "р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е...";

            try {
                // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╕Зр╣Гр╕Щ Collection "tickets"
                await addDoc(collection(db, "tickets"), {
                    internetNo: document.getElementById('internetNo').value,
                    issueType: document.getElementById('issueType').value,
                    details: document.getElementById('details').value,
                    status: "Open", // р╕кр╕Цр╕▓р╕Щр╕░р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
                    email: auth.currentUser.email,
                    createdAt: serverTimestamp(), // р╣Ар╕зр╕ер╕▓р╕Ир╕▓р╕Б Server
                    supNote: "", // р╕кр╕│р╕лр╕гр╕▒р╕Ъ Supervisor р╣Ар╕Вр╕╡р╕вр╕Щр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ
                    isReadSale: true, // р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Эр╕▒р╣Ир╕З Sale (р╕нр╣Ир╕▓р╕Щр╣Бр╕ер╣Йр╕зр╣Ар╕Юр╕гр╕▓р╕░р╣Ар╕Ыр╣Зр╕Щр╕Др╕Щр╕кр╣Ир╕Зр╣Ар╕нр╕З)
                    isReadSup: false  // р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Эр╕▒р╣Ир╕З Supervisor (р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕нр╣Ир╕▓р╕Щ)
                });

                alert("р╕кр╣Ир╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И! р╕Др╕╕р╕Ур╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕кр╕Цр╕▓р╕Щр╕░р╣Др╕Фр╣Йр╕Чр╕╡р╣Ир╣Ар╕бр╕Щр╕╣р╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕Зр╕▓р╕Щ");
                document.getElementById('ticketForm').reset(); // р╕ер╣Йр╕▓р╕Зр╕Яр╕нр╕гр╣Мр╕б
            } catch (err) { 
                console.error(err);
                alert("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: " + err.message); 
            } finally {
                btn.disabled = false; 
                btn.innerText = "р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ир╣Йр╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕З";
            }
        };

        // 4. р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ
        document.getElementById('logoutBtn').onclick = () => {
            if(confirm("р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ?")) {
                signOut(auth).then(() => window.location.href = "../index.html");
            }
        };
    </script>
</body>
</html>
