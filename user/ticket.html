<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">SALE PORTAL</div>
        <div class="sidebar-menu">
            <a href="main.html">üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
            <a href="ticket.html" class="active">üìù <span>‡∏™‡πà‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span></a>
            <a href="history.html">üîç <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="flex: 1; font-weight: 600;">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
            <span id="userEmail" style="font-weight: 600; color: var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>

        <div class="container">
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: var(--primary-green); margin-bottom: 20px;">‚ûï ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Case</h3>
                <form id="ticketForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
                        <select id="issueType" class="input-field" required></select>
                    </div>
                    <div>
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet (10 ‡∏´‡∏•‡∏±‡∏Å):</label>
                        <input type="text" id="internetNo" class="input-field" placeholder="88XXXXXXXX" required pattern="[0-9]{10}">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                        <textarea id="details" class="input-field" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." required></textarea>
                    </div>
                    <div style="grid-column: 1 / -1; text-align: right;">
                        <button type="submit" class="btn btn-primary" id="submitBtn" style="min-width: 200px;">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                
                <div class="search-box">
                    <span style="font-size: 1.2rem;">üîç</span>
                    <input type="text" id="searchInput" class="input-field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet 10 ‡∏´‡∏•‡∏±‡∏Å...">
                </div>

                <div class="table-container" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>Internet No.</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Supervisor</th>
                            </tr>
                        </thead>
                        <tbody id="myTicketsBody">
                            <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
            authDomain: "sale-support-system.firebaseapp.com",
            projectId: "sale-support-system",
            storageBucket: "sale-support-system.firebasestorage.app",
            messagingSenderId: "640337786680",
            appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "../index.html";
            else {
                document.getElementById('userEmail').innerText = user.email;
                loadIssueOptions();
                loadMyTickets(user.email);
            }
        });

        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å Firestore Settings
        function loadIssueOptions() {
            onSnapshot(doc(db, "settings", "issueOptions"), (snap) => {
                const select = document.getElementById('issueType');
                if (snap.exists()) {
                    const options = snap.data().options || [];
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>' + 
                        options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                }
            });
        }

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏ö‡∏ö Real-time
        function loadMyTickets(email, searchTerm = "") {
            const q = query(
                collection(db, "tickets"),
                where("email", "==", email),
                orderBy("createdAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('myTicketsBody');
                let html = '';
                
                snapshot.forEach(docSnap => {
                    const t = docSnap.data();
                    if (searchTerm && !t.internetNo.includes(searchTerm)) return;

                    const date = t.createdAt?.toDate().toLocaleDateString('th-TH') || '-';
                    const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'In Progress' ? 'bg-process' : 'bg-closed');
                    
                    html += `
                        <tr>
                            <td><small>${date}</small></td>
                            <td><b>${t.internetNo}</b></td>
                            <td>${t.issueType}</td>
                            <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                            <td style="color: var(--dark-green); font-size: 0.85rem;">${t.supNote || t.comment || '-'}</td>
                        </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
            });
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Real-time
        document.getElementById('searchInput').addEventListener('input', (e) => {
            loadMyTickets(auth.currentUser.email, e.target.value);
        });

        // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (Submit Ticket)
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            try {
                await addDoc(collection(db, "tickets"), {
                    internetNo: document.getElementById('internetNo').value,
                    issueType: document.getElementById('issueType').value,
                    details: document.getElementById('details').value,
                    status: "Open",
                    email: auth.currentUser.email,
                    createdAt: serverTimestamp(),
                    comment: "",
                    isReadSale: true // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
                });
                alert("‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                document.getElementById('ticketForm').reset();
            } catch (err) { 
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); 
            } finally {
                btn.disabled = false;
                btn.innerText = "üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á";
            }
        });

        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
    </script>
</body>
</html>
