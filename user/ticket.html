<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: 600; }
        .bg-open { background-color: #EF4444; }
        .bg-process { background-color: #F59E0B; }
        .bg-closed { background-color: #10B981; }
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-links">
            <b style="color: var(--primary-green); font-size: 1.2rem; margin-right: 20px;">Sale Portal</b>
            <a href="ticket.html" class="active" style="color: var(--primary-green); border-bottom: 2px solid var(--primary-green);">üìù ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</a>
        </div>
        <div class="nav-links">
            <span id="userEmail" style="font-size: 0.85rem; color: #666; margin-right: 15px;"></span>
            <button class="btn btn-outline" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </nav>

    <div class="container" style="max-width: 1000px;">
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px;">
            <h3 style="color: var(--primary-green); margin-top: 0;">‚ûï ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Case</h3>
            <form id="ticketForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
                    <select id="issueType" class="input-field" required></select>
                </div>
                <div>
                    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet (10 ‡∏´‡∏•‡∏±‡∏Å):</label>
                    <input type="text" id="internetNo" class="input-field" placeholder="88XXXXXXXX" required pattern="[0-9]{10}">
                </div>
                <div style="grid-column: span 2;">
                    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                    <textarea id="details" class="input-field" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn" style="grid-column: span 2; height: 45px;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            </form>
        </div>

        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
            <h3 style="color: var(--primary-green); margin-top: 0;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            
            <div class="search-box">
                <span style="font-weight: 600; color: #4B5563;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</span>
                <input type="text" id="searchInput" class="input-field" style="margin:0; max-width: 300px;" placeholder="‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet 10 ‡∏´‡∏•‡∏±‡∏Å...">
                <small style="color: #9CA3AF;">* ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</small>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                            <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Supervisor</th>
                        </tr>
                    </thead>
                    <tbody id="myTicketsBody">
                        <tr><td colspan="5" style="text-align: center; padding: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            document.getElementById('userEmail').innerText = user.email;
            loadIssueOptions();
            loadMyTickets(user.email); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        }
    });

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Dropdown
    function loadIssueOptions() {
        onSnapshot(doc(db, "settings", "issueOptions"), (snap) => {
            const select = document.getElementById('issueType');
            if (snap.exists()) {
                const options = snap.data().options || [];
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>' + options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            }
        });
    }

    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    function loadMyTickets(email, searchTerm = "") {
        const q = query(
            collection(db, "tickets"),
            where("email", "==", email),
            orderBy("createdAt", "desc") // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        );

        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('myTicketsBody');
            let html = '';
            
            snapshot.forEach(docSnap => {
                const t = docSnap.data();
                // ‡∏£‡∏∞‡∏ö‡∏ö Filter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå Internet
                if (searchTerm && !t.internetNo.includes(searchTerm)) return;

                const date = t.createdAt?.toDate().toLocaleDateString('th-TH') || '-';
                const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'In Progress' ? 'bg-process' : 'bg-closed');
                
                html += `
                    <tr>
                        <td><small>${date}</small></td>
                        <td><b>${t.internetNo}</b></td>
                        <td>${t.issueType}</td>
                        <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                        <td style="color: #059669; font-size: 0.85rem;">${t.comment || '-'}</td>
                    </tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        });
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Real-time (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    document.getElementById('searchInput').addEventListener('input', (e) => {
        loadMyTickets(auth.currentUser.email, e.target.value);
    });

    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
    document.getElementById('ticketForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        try {
            await addDoc(collection(db, "tickets"), {
                internetNo: document.getElementById('internetNo').value,
                issueType: document.getElementById('issueType').value,
                details: document.getElementById('details').value,
                status: "Open",
                email: auth.currentUser.email,
                createdAt: serverTimestamp(),
                comment: ""
            });
            alert("‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            document.getElementById('ticketForm').reset();
        } catch (err) { alert(err.message); }
        btn.disabled = false;
    });

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
</script>
</body>
</html>
