<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Sale Support | Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS ‡∏Å‡∏•‡∏≤‡∏á -->
<link rel="stylesheet" href="assets/css/main.css">
</head>

<body>

<!-- layout.js ‡∏à‡∏∞ render ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
<div id="app"></div>

<!-- Layout + Auth + Permission -->
<script type="module" src="assets/js/layout.js"></script>

<!-- Page Script -->
<script type="module">
import { auth, db } from "./assets/js/firebase.js";
import {
  collection,
  query,
  where,
  getCountFromServer
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* =========================
   LOAD HOME DASHBOARD
========================= */
onAuthStateChanged(auth, async user=>{
  if(!user) return;

  // ‡∏£‡∏≠ layout render ‡∏Å‡πà‡∏≠‡∏ô
  setTimeout(async ()=>{
    const content = document.getElementById("pageContent");
    if(!content) return;

    content.innerHTML = `
      <div class="card">
        <h2>üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô Sale Support</p>
      </div>

      <div class="stat">
        <div class="card">
          Open<br><b id="openCount">0</b>
        </div>
        <div class="card">
          Pending<br><b id="pendingCount">0</b>
        </div>
        <div class="card">
          Closed<br><b id="closedCount">0</b>
        </div>
      </div>
    `;

    // ===== Query ‡∏ô‡∏±‡∏ö Ticket ‡∏Ç‡∏≠‡∏á User =====
    const openQ = query(
      collection(db,"tickets"),
      where("uid","==",user.uid),
      where("status","==","Open")
    );

    const pendingQ = query(
      collection(db,"tickets"),
      where("uid","==",user.uid),
      where("status","==","Pending")
    );

    const closedQ = query(
      collection(db,"tickets"),
      where("uid","==",user.uid),
      where("status","==","Closed")
    );

    document.getElementById("openCount").innerText =
      (await getCountFromServer(openQ)).data().count;

    document.getElementById("pendingCount").innerText =
      (await getCountFromServer(pendingQ)).data().count;

    document.getElementById("closedCount").innerText =
      (await getCountFromServer(closedQ)).data().count;

  },300);
});
</script>

</body>
</html>
