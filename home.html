<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Sale Support | Home</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/css/main.css">

</head>
<body>

<div class="layout">

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar">
    <div class="logo">ğŸŸ¢ Sale Support</div>

    <nav class="menu">
      <a href="home.html" data-role="Admin,Supervisor,User">ğŸ  Home</a>
      <a href="ticket-create.html" data-role="User">ğŸ“ à¹à¸ˆà¹‰à¸‡à¸›à¸±à¸à¸«à¸²</a>
      <a href="ticket-my.html" data-role="User">ğŸ“„ Ticket à¸‚à¸­à¸‡à¸‰à¸±à¸™</a>
      <a href="ticket-close.html" data-role="Supervisor,Admin">âœ… à¸›à¸´à¸” Ticket</a>
      <a href="admin-all.html" data-role="Admin">ğŸ“Š à¸‡à¸²à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</a>
      <a href="dashboard.html" data-role="Admin,Supervisor">ğŸ“ˆ Dashboard</a>
      <a href="ticket-management.html" data-role="Admin">âš™ï¸ Ticket Management</a>
      <a href="user-management.html" data-role="Admin">ğŸ‘¤ User Management</a>
      <a href="permission.html" data-role="Admin">ğŸ” Permission</a>
    </nav>

    <div class="bottom">
      <button id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">

    <!-- TOP BAR -->
    <div class="topbar">
      <h2>Home</h2>
      <div id="userInfo">Loading...</div>
    </div>

    <!-- DASHBOARD USER -->
    <div class="card">
      <h3>ğŸ“Œ à¸ªà¸£à¸¸à¸› Ticket à¸‚à¸­à¸‡à¸„à¸¸à¸“</h3>
      <p id="summaryText">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</p>
    </div>

  </main>
</div>

<!-- ================= SCRIPT ================= -->
<script type="module">

import { auth, db } from "./assets/js/firebase.js";
import { onAuthStateChanged, signOut } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, query, where, getDocs } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const userInfo = document.getElementById("userInfo");
const summaryText = document.getElementById("summaryText");
const logoutBtn = document.getElementById("logoutBtn");
const menus = document.querySelectorAll(".menu a");

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    location.href="index.html";
    return;
  }

  const roleSnap = await fetch(`https://firestore.googleapis.com/v1/projects/sale-support-system/databases/(default)/documents/users/${user.uid}`);
  const roleData = await roleSnap.json();
  const role = roleData.fields.role.stringValue;
  const fullname = roleData.fields.fullname.stringValue;

  userInfo.innerText = `${fullname} (${role})`;

  /* ===== Show menu by role ===== */
  menus.forEach(m=>{
    const allow = m.dataset.role.split(",");
    if(!allow.includes(role)) m.style.display="none";
  });

  /* ===== Load ticket summary ===== */
  if(role === "User"){
    const q = query(
      collection(db,"tickets"),
      where("uid","==",user.uid)
    );
    const snap = await getDocs(q);
    summaryText.innerHTML = `
      ğŸ« Ticket à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <b>${snap.size}</b> à¹ƒà¸š
    `;
  }else{
    summaryText.innerHTML = "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£ Ticket";
  }
});

/* ===== Logout ===== */
logoutBtn.addEventListener("click",()=>{
  signOut(auth).then(()=>{
    location.href="index.html";
  });
});

</script>

</body>
</html>
