<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Register - Sale Support System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
</head>

<body class="auth-body">

<div class="auth-card">
  <h2 class="auth-title">สร้างบัญชีผู้ใช้งาน</h2>

  <form id="registerForm">

    <div class="form-group">
      <label>ชื่อ - นามสกุล</label>
      <input type="text" id="fullName" class="input-field" required>
    </div>

    <div class="form-group">
      <label>หน่วยงาน</label>
      <select id="department" class="input-field" required>
        <option value="">-- กรุณาเลือก --</option>
        <option value="FBB Telesale">FBB Telesale</option>
        <option value="FBB Dealer Sale">FBB Dealer Sale</option>
        <option value="FBB Direct Sale">FBB Direct Sale</option>
      </select>
    </div>

    <div class="form-group">
      <label>ทีม</label>
      <select id="team" class="input-field" required disabled>
        <option value="">-- กรุณาเลือกหน่วยงานก่อน --</option>
      </select>
    </div>

    <div class="form-group">
      <label>เบอร์โทรศัพท์</label>
      <input type="tel" id="phone" class="input-field" required>
    </div>

    <div class="form-group">
      <label>อีเมลพนักงาน</label>
      <input type="email" id="email" class="input-field" required>
    </div>

    <div class="form-group">
      <label>รหัสผ่าน</label>
      <input type="password" id="password" class="input-field" required minlength="6">
    </div>

    <div class="form-group">
      <label>ยืนยันรหัสผ่าน</label>
      <input type="password" id="confirmPassword" class="input-field" required>
    </div>

    <button type="submit" class="btn-auth" id="regBtn">
      สมัครใช้งาน
    </button>
  </form>
</div>

<!-- Loading -->
<div id="loadingOverlay" class="overlay hidden">
  <div class="spinner"></div>
  <p>กำลังสร้างบัญชี...</p>
</div>

<!-- Success -->
<div id="successOverlay" class="overlay hidden">
  <div class="success-card">
    <div class="checkmark">✓</div>
    <h3>สมัครใช้งานสำเร็จ</h3>
    <p>กำลังเข้าสู่ระบบ...</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
    authDomain: "sale-support-system.firebaseapp.com",
    projectId: "sale-support-system",
    storageBucket: "sale-support-system.firebasestorage.app",
    messagingSenderId: "640337786680",
    appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* Department -> Team */
  const departmentEl = document.getElementById("department");
  const teamEl = document.getElementById("team");

  departmentEl.addEventListener("change", () => {
    teamEl.innerHTML = "";
    teamEl.disabled = false;

    let teams = [];

    if (departmentEl.value === "FBB Dealer Sale") {
      teams = Array.from({ length: 10 }, (_, i) => `Team ${i + 1}`);
    }
    if (departmentEl.value === "FBB Direct Sale") {
      teams = Array.from({ length: 6 }, (_, i) => `Team ${i + 1}`);
    }
    if (departmentEl.value === "FBB Telesale") {
      teamEl.innerHTML = `<option value="Telesale">Telesale</option>`;
      return;
    }

    teams.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teamEl.appendChild(opt);
    });
  });

  /* Register */
  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const password = password.value;
    const confirm = confirmPassword.value;
    if (password !== confirm) {
      alert("รหัสผ่านไม่ตรงกัน");
      return;
    }

    loadingOverlay.classList.remove("hidden");

    try {
      const userCred = await createUserWithEmailAndPassword(
        auth,
        email.value,
        password
      );

      await setDoc(doc(db, "users", userCred.user.uid), {
        fullName: fullName.value,
        department: department.value,
        team: team.value,
        phone: phone.value,
        email: email.value,
        role: "user",
        createdAt: new Date()
      });

      loadingOverlay.classList.add("hidden");
      successOverlay.classList.remove("hidden");

      setTimeout(() => {
        window.location.href = "./user/main.html";
      }, 2000);

    } catch (err) {
      loadingOverlay.classList.add("hidden");
      alert(err.message);
    }
  });
</script>

</body>
</html>
