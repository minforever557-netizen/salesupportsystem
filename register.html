<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>สมัครเข้าใช้งาน | Sale Support</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
</head>

<body class="auth-body">

<div class="auth-card">
    <h2 class="auth-title">สมัครเข้าใช้งาน</h2>
    <p class="card-subtitle">Sale Support Management System</p>

    <form id="registerForm">
        <div class="form-group">
            <label>ชื่อ - นามสกุล</label>
            <input type="text" id="fullname" class="input-field" required>
        </div>

        <div class="form-group">
            <label>หน่วยงาน</label>
            <select id="department" class="input-field" required>
                <option value="">-- เลือกหน่วยงาน --</option>
                <option value="FBB">FBB</option>
                <option value="Mobile">Mobile</option>
            </select>
        </div>

        <div class="form-group" id="teamGroup">
            <label>ทีม</label>
            <select id="team" class="input-field">
                <option value="">-- เลือกทีม --</option>
                <option value="Telesale">Telesale</option>
                <option value="Retail">Retail</option>
            </select>
        </div>

        <div class="form-group">
            <label>เบอร์โทรศัพท์</label>
            <input type="tel" id="phone" class="input-field" required>
        </div>

        <div class="form-group">
            <label>อีเมลพนักงาน</label>
            <input type="email" id="email" class="input-field" required>
        </div>

        <div class="form-group">
            <label>รหัสผ่าน</label>
            <input type="password" id="password" class="input-field" required minlength="6">
        </div>

        <button type="submit" class="btn-auth">ลงทะเบียนเข้าใช้งาน</button>

        <p class="text-center" style="margin-top:15px;">
            มีบัญชีแล้ว? <a href="../index.html" class="link">เข้าสู่ระบบ</a>
        </p>
    </form>
</div>

<!-- Loading -->
<div id="loading" class="overlay hidden">
    <div class="spinner"></div>
    <p>กำลังดำเนินการ...</p>
</div>

<!-- Email Exists Modal -->
<div id="existUserModal" class="overlay hidden">
    <div class="success-card">
        <h3 style="color:#f97316;">อีเมลนี้มีบัญชีผู้ใช้งานอยู่แล้ว</h3>

        <button id="goLogin" class="btn-auth" style="margin-top:15px;">
            เข้าสู่ระบบ
        </button>

        <button id="goReset" class="btn-auth" style="margin-top:10px; background:#10b981;">
            รีเซ็ตรหัสผ่าน
        </button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
    getAuth,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
    getFirestore,
    doc,
    setDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
    apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
    authDomain: "sale-support-system.firebaseapp.com",
    projectId: "sale-support-system",
    storageBucket: "sale-support-system.firebasestorage.app",
    messagingSenderId: "640337786680",
    appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const form = document.getElementById("registerForm");
const loading = document.getElementById("loading");
const modal = document.getElementById("existUserModal");

/* Hide Team when FBB Telesale */
document.getElementById("department").addEventListener("change", e => {
    const teamGroup = document.getElementById("teamGroup");
    teamGroup.style.display = e.target.value === "FBB" ? "none" : "block";
});

/* Submit Register */
form.addEventListener("submit", async e => {
    e.preventDefault();
    loading.classList.remove("hidden");

    const fullname = fullname.value;
    const department = department.value;
    const team = team.value;
    const phone = phone.value;
    const email = email.value;
    const password = password.value;

    try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);

        await setDoc(doc(db, "users", cred.user.uid), {
            fullname,
            department,
            team: department === "FBB" ? "-" : team,
            phone,
            email,
            role: "sale",
            createdAt: new Date()
        });

        window.location.href = "../index.html";

    } catch (err) {
        loading.classList.add("hidden");

        if (err.code === "auth/email-already-in-use") {
            modal.classList.remove("hidden");
        } else {
            alert(err.message);
        }
    }
});

/* Modal Actions */
document.getElementById("goLogin").onclick = () => {
    window.location.href = "../index.html";
};

document.getElementById("goReset").onclick = async () => {
    const email = document.getElementById("email").value;
    await sendPasswordResetEmail(auth, email);
    alert("ส่งลิงก์รีเซ็ตรหัสผ่านแล้ว");
    window.location.href = "../index.html";
};
</script>

</body>
</html>
