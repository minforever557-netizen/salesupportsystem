<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Register | Sale Support System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/register.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
  authDomain: "sale-support-system.firebaseapp.com",
  projectId: "sale-support-system",
  storageBucket: "sale-support-system.firebasestorage.app",
  messagingSenderId: "640337786680",
  appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.registerUser = async function () {
  const fullname = fullnameEl.value.trim();
  const department = departmentEl.value;
  const team = teamEl.value || "-";
  const phone = phoneEl.value.trim();
  const email = emailEl.value.trim();
  const password = passwordEl.value;

  if (!fullname || !department || !phone || !email || !password) {
    showError("กรุณากรอกข้อมูลให้ครบถ้วน");
    return;
  }

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    await setDoc(doc(db, "users", cred.user.uid), {
      fullname,
      department,
      team,
      phone,
      email,
      role: "user",
      createdAt: serverTimestamp()
    });

    // ✅ สมัครสำเร็จ → ไปหน้า Login
    alert("สมัครสำเร็จ กรุณาเข้าสู่ระบบ");
    window.location.href = "index.html";

  } catch (err) {
    showRegisterFail();
  }
}
</script>
</head>

<body>

<div class="container">
  <h1>สมัครเข้าใช้งาน</h1>

  <label>ชื่อ - นามสกุล</label>
  <input id="fullnameEl">

  <label>หน่วยงาน</label>
  <select id="departmentEl">
    <option value="">-- กรุณาเลือก --</option>
    <option>FBB Telesale</option>
    <option>FBB Dealer Sale</option>
    <option>FBB Direct Sale</option>
  </select>

  <div id="teamWrapper">
    <label>ทีม</label>
    <select id="teamEl">
      <option value="">-- กรุณาเลือกทีม --</option>
    </select>
  </div>

  <label>เบอร์โทรศัพท์</label>
  <input id="phoneEl">

  <label>อีเมลพนักงาน</label>
  <input id="emailEl">

  <label>รหัสผ่าน</label>
  <input type="password" id="passwordEl">

  <button onclick="registerUser()">ลงทะเบียนเข้าใช้งาน</button>
</div>

<!-- ERROR MODAL -->
<div class="modal" id="errorModal">
  <div class="modal-box">
    <h3>ไม่สามารถสมัครได้</h3>
    <p>อีเมลนี้อาจมีบัญชีอยู่แล้ว<br>กรุณาเลือกการดำเนินการ</p>
    <button onclick="location.href='index.html'">เข้าสู่ระบบ</button>
    <button class="btn-secondary" onclick="location.href='forgot.html'">
      รีเซ็ตรหัสผ่าน
    </button>
  </div>
</div>

<script>
const departmentEl = document.getElementById("departmentEl");
const teamEl = document.getElementById("teamEl");
const teamWrapper = document.getElementById("teamWrapper");

departmentEl.addEventListener("change", () => {
  teamEl.innerHTML = `<option value="">-- กรุณาเลือกทีม --</option>`;
  teamWrapper.classList.remove("hide");

  if (departmentEl.value === "FBB Telesale") {
    teamWrapper.classList.add("hide");
    return;
  }

  let max = departmentEl.value === "FBB Dealer Sale" ? 10 : 6;
  for (let i = 1; i <= max; i++) {
    teamEl.innerHTML += `<option>Team ${i}</option>`;
  }
});

function showRegisterFail() {
  document.getElementById("errorModal").style.display = "flex";
}
</script>

</body>
</html>
