<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Register - Sale Support System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
</head>

<body class="center-layout">

<div class="card" style="max-width:460px">

  <div class="card-title">SALE PORTAL</div>
  <div class="card-subtitle">Support Management System</div>

  <form id="registerForm">

    <div class="form-group">
      <label>ชื่อ - นามสกุล</label>
      <input class="input" id="fullName" required>
    </div>

    <div class="form-group">
      <label>หน่วยงาน</label>
      <select class="input" id="department" required>
        <option value="">-- กรุณาเลือก --</option>
        <option value="FBB Telesale">FBB Telesale</option>
        <option value="FBB Dealer Sale">FBB Dealer Sale</option>
        <option value="FBB Direct Sale">FBB Direct Sale</option>
      </select>
    </div>

    <div class="form-group">
      <label>ทีม</label>
      <select class="input" id="team" required>
        <option value="">-- กรุณาเลือกทีม --</option>
      </select>
    </div>

    <div class="form-group">
      <label>เบอร์โทรศัพท์</label>
      <input class="input" id="phone" required>
    </div>

    <div class="form-group">
      <label>อีเมลพนักงาน</label>
      <input type="email" class="input" id="email" required>
    </div>

    <div class="form-group">
      <label>รหัสผ่าน</label>
      <input type="password" class="input" id="password" required minlength="6">
    </div>

    <button type="submit" class="btn" id="regBtn">
      ลงทะเบียนเข้าใช้งาน
    </button>

  </form>

  <div class="text-center" style="margin-top:16px">
    มีบัญชีแล้ว? <a class="link" href="index.html">เข้าสู่ระบบ</a>
  </div>

</div>

<!-- EMAIL EXISTS MODAL -->
<div class="overlay hidden" id="emailExistsModal">
  <div class="success-card">
    <div class="checkmark" style="background:#f59e0b">!</div>
    <p>
      อีเมลนี้มีบัญชีผู้ใช้งานอยู่แล้ว<br>
      กรุณาเลือกการดำเนินการ
    </p>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button class="btn" onclick="goLogin()">เข้าสู่ระบบ</button>
      <button class="btn-outline" onclick="goReset()">รีเซ็ตรหัสผ่าน</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
    authDomain: "sale-support-system.firebaseapp.com",
    projectId: "sale-support-system",
    storageBucket: "sale-support-system.firebasestorage.app",
    messagingSenderId: "640337786680",
    appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const department = document.getElementById("department");
  const team = document.getElementById("team");

  department.onchange = () => {
    team.innerHTML = '<option value="">-- กรุณาเลือกทีม --</option>';
    if (department.value === "FBB Dealer Sale") {
      for (let i = 1; i <= 10; i++) team.innerHTML += `<option>Team ${i}</option>`;
    }
    if (department.value === "FBB Direct Sale") {
      for (let i = 1; i <= 6; i++) team.innerHTML += `<option>Team ${i}</option>`;
    }
    if (department.value === "FBB Telesale") {
      team.innerHTML += `<option>Telesale</option>`;
    }
  };

  document.getElementById("registerForm").onsubmit = async (e) => {
    e.preventDefault();
    regBtn.disabled = true;
    regBtn.innerText = "กำลังดำเนินการ...";

    try {
      const email = email.value;
      const password = password.value;

      const cred = await createUserWithEmailAndPassword(auth, email, password);

      await setDoc(doc(db, "users", cred.user.uid), {
        fullName: fullName.value,
        phone: phone.value,
        department: department.value,
        team: team.value,
        email,
        role: "user",
        createdAt: serverTimestamp()
      });

      window.location.href = "user/main.html";

    } catch (error) {
      regBtn.disabled = false;
      regBtn.innerText = "ลงทะเบียนเข้าใช้งาน";

      if (error.code === "auth/email-already-in-use") {
        document.getElementById("emailExistsModal").classList.remove("hidden");
      } else {
        alert("เกิดข้อผิดพลาด กรุณาลองใหม่");
      }
    }
  };

  window.goLogin = () => window.location.href = "index.html";
  window.goReset = () => window.location.href = "forgot-password.html";
</script>

</body>
</html>
