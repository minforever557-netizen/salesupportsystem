<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin & Supervisor Dashboard</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Section */
        .section-content { display: none; }
        .section-content.active { display: block; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå Sidebar ‡πÉ‡∏´‡∏°‡πà */
        .sidebar-menu a { cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu a:hover { background: #374151; }
        .sidebar-menu a.active { background: #10B981; color: white; border-radius: 8px; }
        
        /* Badge ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        .menu-badge {
            background: #ef4444; color: white; border-radius: 50%;
            padding: 2px 7px; font-size: 11px; margin-left: auto;
        }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° */
        .btn-manage { background: #111827; color: white; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
        .search-container { margin-bottom: 20px; position: relative; }
        .search-container input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 10px; border: 1px solid #ddd; }
        .search-icon { position: absolute; left: 15px; top: 13px; color: #94a3b8; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">ADMIN / SUPERVISOR</div>
        <div class="sidebar-menu">
            <a onclick="showSection('pending')" id="menu-pending" class="active">
                ‚è≥ <span>‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span> <span class="menu-badge" id="badgePending">0</span>
            </a>
            <a onclick="showSection('manage')" id="menu-manage">
                üõ†Ô∏è <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Ticket (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
            </a>
            <a onclick="showSection('history')" id="menu-history">
                üìú <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </a>
            <hr style="border:0; border-top:1px solid #374151; margin:15px 0;">
            <a onclick="showSection('create')" id="menu-create">
                ‚ûï <span>‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà</span>
            </a>
            <a href="users.html">üë• <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></a>
            <a href="#" id="logoutBtn" style="color: #ef4444; margin-top: 20px;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div id="section-pending" class="section-content active">
            <div class="container">
                <h2 style="margin-bottom: 20px;">‚è≥ ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Open Cases)</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>SALE</th>
                                <th>Internet No.</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="section-manage" class="section-content">
            <div class="container">
                <h2 style="margin-bottom: 20px;">üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Internet No.</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="allManageTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="section-history" class="section-content">
            <div class="container">
                <h2 style="margin-bottom: 20px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="historySearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet 10 ‡∏´‡∏•‡∏±‡∏Å..." onkeyup="filterHistory()">
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>Internet No.</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ Admin</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="section-create" class="section-content">
            <div class="container">
                <div class="card" style="max-width: 600px; margin: auto;">
                    <h2>‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Ticket ‡πÉ‡∏´‡∏°‡πà (Admin/Sup Mode)</h2>
                    <form id="adminCreateForm">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet (10 ‡∏´‡∏•‡∏±‡∏Å):</label>
                        <input type="text" id="newInternetNo" class="input-field" maxlength="10" required>
                        <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
                        <select id="newTopic" class="input-field" required></select>
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
                        <textarea id="newDetail" class="input-field" rows="4"></textarea>
                        <button type="submit" class="btn" style="background:#10B981; color:white; width:100%;">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
    window.showSection = (id) => {
        document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        document.getElementById('section-' + id).classList.add('active');
        document.getElementById('menu-' + id).classList.add('active');
    };

    // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    window.goToManage = (id) => {
        localStorage.setItem('adminEditTicketId', id);
        window.location.href = 'admin-manage.html';
    };

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time
    onSnapshot(query(collection(db, "tickets"), orderBy("createdAt", "desc")), (snap) => {
        let pendingHtml = '';
        let manageHtml = '';
        let historyHtml = '';
        let pendingCount = 0;

        snap.forEach(docSnap => {
            const t = docSnap.data();
            const id = docSnap.id;
            const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process');
            const dateStr = t.createdAt?.toDate().toLocaleString('th-TH', {hour12:false}) || '-';

            // 1. ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Open ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            if (t.status === 'Open') {
                pendingCount++;
                pendingHtml += `<tr>
                    <td>${t.email?.split('@')[0]}</td>
                    <td><b>${t.internetNo}</b></td>
                    <td>${t.topic}</td>
                    <td><small>${dateStr}</small></td>
                    <td><button class="btn-manage" onclick="goToManage('${id}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button></td>
                </tr>`;
            }

            // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Closed)
            if (t.status !== 'Closed') {
                manageHtml += `<tr>
                    <td><b>${t.internetNo}</b></td>
                    <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                    <td>${t.processedBy || '-'}</td>
                    <td><button class="btn-manage" onclick="goToManage('${id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
                </tr>`;
            }

            // 3. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            historyHtml += `<tr>
                <td><small>${dateStr}</small></td>
                <td><b>${t.internetNo}</b></td>
                <td>${t.topic}</td>
                <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                <td style="color:#10B981;">${t.supNote || t.comment || '-'}</td>
            </tr>`;
        });

        document.getElementById('badgePending').innerText = pendingCount;
        document.getElementById('pendingTable').innerHTML = pendingHtml || '<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>';
        document.getElementById('allManageTable').innerHTML = manageHtml;
        document.getElementById('historyTable').innerHTML = historyHtml;
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    onSnapshot(doc(db, "settings", "issueOptions"), (s) => {
        if(s.exists()){
            const options = s.data().options || [];
            document.getElementById('newTopic').innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }
    });

    // Logout
    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");

    // Filter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    window.filterHistory = () => {
        const input = document.getElementById('historySearch').value.toLowerCase();
        const rows = document.querySelectorAll('#historyTable tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        });
    };
</script>
</body>
</html>
