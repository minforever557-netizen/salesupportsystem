<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">ADMIN PANEL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üìä <span>Dashboard</span></a>
            <a href="users.html">üë• <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar"><span id="adminEmail" style="font-weight: 600;">Admin Loading...</span></div>
        <div class="container">
            <h2>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                <div class="card" style="background: #1e293b; color: white; text-align: center;">
                    <small>Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><div id="totalTicket" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="card" style="background: #ef4444; color: white; text-align: center;">
                    <small>Open</small><div id="totalOpen" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="card" style="background: #f59e0b; color: white; text-align: center;">
                    <small>In Progress</small><div id="totalProcess" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="card" style="background: #10b981; color: white; text-align: center;">
                    <small>Closed</small><div id="totalClosed" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div class="card">
                    <h3>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <input type="text" id="newIssueInput" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà..." style="margin:0;">
                        <button id="addIssueBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div id="issueList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div class="card">
                    <h3>üëÅÔ∏è ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</h3>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sale ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="recentTickets"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            document.getElementById('adminEmail').innerText = "Admin: " + user.email;
            loadDashboard();
        }
    });

    function loadDashboard() {
        // ‡∏î‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏Å Status)
        onSnapshot(query(collection(db, "tickets"), orderBy("createdAt", "desc")), (snap) => {
            let stats = { all: snap.size, open: 0, process: 0, closed: 0 };
            let html = '';
            snap.forEach(docSnap => {
                const t = docSnap.data();
                if (t.status === 'Open') stats.open++;
                if (t.status === 'In Progress') stats.process++;
                if (t.status === 'Closed') stats.closed++;

                const statusClass = t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process');
                html += `<tr>
                    <td><small>${t.email}</small></td>
                    <td><b>${t.internetNo}</b></td>
                    <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                    <td><button class="btn btn-primary" onclick="editJob('${docSnap.id}')" style="padding:4px 8px; font-size:0.75rem;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
                </tr>`;
            });
            document.getElementById('totalTicket').innerText = stats.all;
            document.getElementById('totalOpen').innerText = stats.open;
            document.getElementById('totalProcess').innerText = stats.process;
            document.getElementById('totalClosed').innerText = stats.closed;
            document.getElementById('recentTickets').innerHTML = html;
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
        const settingsRef = doc(db, "settings", "issueOptions");
        onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                const options = docSnap.data().options || [];
                document.getElementById('issueList').innerHTML = options.map(opt => `
                    <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                        <span>${opt}</span>
                        <button onclick="deleteIssue('${opt}')" style="color:red; border:none; background:none; cursor:pointer;">‡∏•‡∏ö</button>
                    </div>
                `).join('');
            }
        });

        window.deleteIssue = async (val) => {
            if (confirm('‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ' + val)) await updateDoc(settingsRef, { options: arrayRemove(val) });
        };
        document.getElementById('addIssueBtn').onclick = async () => {
            const input = document.getElementById('newIssueInput');
            if (input.value) await updateDoc(settingsRef, { options: arrayUnion(input.value) });
            input.value = '';
        };
    }

    window.editJob = (id) => {
        localStorage.setItem('currentTicketId', id);
        window.location.href = '../supervisor/manage-job.html';
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
</script>
</body>
</html>
