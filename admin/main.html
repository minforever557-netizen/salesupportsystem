<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .admin-dashboard-grid { display: grid; grid-template-columns: 1.2fr 2fr; gap: 25px; margin-top: 20px; }
        .stat-card { padding: 25px; border-radius: 15px; color: white; position: relative; overflow: hidden; }
        .stat-card h4 { margin: 0; font-weight: 300; opacity: 0.9; }
        .stat-card .val { font-size: 2.2rem; font-weight: 600; margin: 10px 0; }
        
        .issue-list-container { max-height: 350px; overflow-y: auto; margin-top: 15px; }
        .issue-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid #f0f0f0; transition: 0.2s;
        }
        .issue-item:hover { background: #f9fafb; }
        .btn-del { background: #fee2e2; color: #ef4444; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .btn-del:hover { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">ADMIN PANEL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üìä <span>Dashboard</span></a>
            <a href="users.html">üë• <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <span id="adminEmail" style="font-weight: 600; color: var(--text-muted);">Admin Portal</span>
        </div>
        
        <div class="container">
            <h2>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö (System Overview)</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0;">
                <div class="stat-card" style="background: #1e293b;"><h4>Total Tickets</h4><div class="val" id="totalAll">0</div></div>
                <div class="stat-card" style="background: #ef4444;"><h4>New (Open)</h4><div class="val" id="totalOpen">0</div></div>
                <div class="stat-card" style="background: #f59e0b;"><h4>In Progress</h4><div class="val" id="totalProcess">0</div></div>
                <div class="stat-card" style="background: #10b981;"><h4>Completed</h4><div class="val" id="totalClosed">0</div></div>
            </div>

            <div class="admin-dashboard-grid">
                <div class="card">
                    <h3>üõ†Ô∏è ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Sale ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="issueInput" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà..." style="margin:0;">
                        <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>

                    <div class="issue-list-container" id="issueList">
                        <p style="text-align: center; color: #ccc;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üëÅÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <div style="overflow-x: auto;">
                        <table style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                                    <th>Sale ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Sup)</th>
                                </tr>
                            </thead>
                            <tbody id="recentTable">
                                <tr><td colspan="4" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, collection, query, orderBy, limit, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            document.getElementById('adminEmail').innerText = "Administrator: " + user.email;
            syncDashboard();
        }
    });

    function syncDashboard() {
        // 1. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Monitor)
        onSnapshot(query(collection(db, "tickets"), orderBy("createdAt", "desc")), (snap) => {
            let counts = { all: snap.size, open: 0, process: 0, closed: 0 };
            let tableHtml = '';
            
            snap.forEach((doc, idx) => {
                const t = doc.data();
                if(t.status === 'Open') counts.open++;
                else if(t.status === 'In Progress') counts.process++;
                else if(t.status === 'Closed') counts.closed++;

                if(idx < 8) { // ‡πÅ‡∏™‡∏î‡∏á 8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    tableHtml += `
                        <tr>
                            <td><b>${t.internetNo}</b></td>
                            <td><small>${t.email.split('@')[0]}</small></td>
                            <td><span class="status-badge ${t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process')}">${t.status}</span></td>
                            <td><small>${t.processedBy ? t.processedBy.split('@')[0] : '-'}</small></td>
                        </tr>`;
                }
            });

            document.getElementById('totalAll').innerText = counts.all;
            document.getElementById('totalOpen').innerText = counts.open;
            document.getElementById('totalProcess').innerText = counts.process;
            document.getElementById('totalClosed').innerText = counts.closed;
            document.getElementById('recentTable').innerHTML = tableHtml || '<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        });

        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Settings)
        const settingsRef = doc(db, "settings", "issueOptions");
        onSnapshot(settingsRef, (s) => {
            if(s.exists()){
                const options = s.data().options || [];
                document.getElementById('issueList').innerHTML = options.map(opt => `
                    <div class="issue-item">
                        <span>${opt}</span>
                        <button class="btn-del" onclick="removeIssue('${opt}')">‡∏•‡∏ö</button>
                    </div>
                `).join('');
            }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
        document.getElementById('addBtn').onclick = async () => {
            const val = document.getElementById('issueInput').value.trim();
            if(!val) return;
            await updateDoc(settingsRef, { options: arrayUnion(val) });
            document.getElementById('issueInput').value = '';
        };

        // ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
        window.removeIssue = async (val) => {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ' + val)) {
                await updateDoc(settingsRef, { options: arrayRemove(val) });
            }
        };
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
</script>
</body>
</html>
