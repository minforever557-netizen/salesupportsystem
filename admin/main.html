<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Sale Support System</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .admin-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; text-align: center; }
        .issue-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid #eee; 
        }
        .issue-item:last-child { border-bottom: none; }
        .btn-delete { background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">ADMIN CONTROL</div>
        <div class="sidebar-menu">
            <a href="main.html" class="active">üìä <span>Dashboard</span></a>
            <a href="users.html">üë• <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></a>
            <hr style="border:0; border-top:1px solid #374151; margin:10px 0;">
            <a href="#" id="logoutBtn" style="color: #ef4444;">üö™ <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar"><span id="adminEmail" style="font-weight: 600;">Admin Loading...</span></div>
        <div class="container">
            <h2 style="margin-bottom: 20px;">üéõÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                <div class="stat-card" style="background: #111827;">
                    <small>Ticket ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><div id="totalTicket" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="stat-card" style="background: #EF4444;">
                    <small>Open</small><div id="totalOpen" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="stat-card" style="background: #F59E0B;">
                    <small>In Progress</small><div id="totalProcess" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
                <div class="stat-card" style="background: #10B981;">
                    <small>Closed</small><div id="totalClosed" style="font-size: 1.5rem; font-weight: 600;">0</div>
                </div>
            </div>

            <div class="admin-grid">
                <div class="card">
                    <h3>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                    <p style="font-size: 0.85rem; color: gray; margin-bottom: 15px;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏õ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πà‡∏á Ticket ‡∏Ç‡∏≠‡∏á Sale</p>
                    
                    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <input type="text" id="newIssueInput" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà..." style="margin:0;">
                        <button id="addIssueBtn" class="btn btn-primary" style="white-space: nowrap;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>

                    <div id="issueList" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                        </div>
                </div>

                <div class="card">
                    <h3>üëÅÔ∏è ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div style="overflow-x: auto;">
                        <table style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Sale</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Internet</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Sup)</th>
                                </tr>
                            </thead>
                            <tbody id="recentTickets">
                                <tr><td colspan="4" style="text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "../index.html";
        else {
            document.getElementById('adminEmail').innerText = "Admin: " + user.email;
            initAdminDashboard();
        }
    });

    function initAdminDashboard() {
        // 1. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        onSnapshot(query(collection(db, "tickets"), orderBy("createdAt", "desc")), (snap) => {
            let stats = { all: snap.size, open: 0, process: 0, closed: 0 };
            let recentHtml = '';
            
            snap.forEach((doc, index) => {
                const t = doc.data();
                if (t.status === 'Open') stats.open++;
                if (t.status === 'In Progress') stats.process++;
                if (t.status === 'Closed') stats.closed++;

                if (index < 5) { // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 5 ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    recentHtml += `<tr>
                        <td>${t.email.split('@')[0]}</td>
                        <td><b>${t.internetNo}</b></td>
                        <td><span class="status-badge ${t.status === 'Open' ? 'bg-open' : (t.status === 'Closed' ? 'bg-closed' : 'bg-process')}">${t.status}</span></td>
                        <td>${t.processedBy ? t.processedBy.split('@')[0] : '-'}</td>
                    </tr>`;
                }
            });

            document.getElementById('totalTicket').innerText = stats.all;
            document.getElementById('totalOpen').innerText = stats.open;
            document.getElementById('totalProcess').innerText = stats.process;
            document.getElementById('totalClosed').innerText = stats.closed;
            document.getElementById('recentTickets').innerHTML = recentHtml;
        });

        // 2. ‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Settings)
        const settingsRef = doc(db, "settings", "issueOptions");
        onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                const options = docSnap.data().options || [];
                const listHtml = options.map(opt => `
                    <div class="issue-item">
                        <span>${opt}</span>
                        <button class="btn-delete" onclick="deleteIssue('${opt}')">‡∏•‡∏ö</button>
                    </div>
                `).join('');
                document.getElementById('issueList').innerHTML = listHtml;
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
        document.getElementById('addIssueBtn').onclick = async () => {
            const input = document.getElementById('newIssueInput');
            if (!input.value) return;
            await updateDoc(settingsRef, { options: arrayUnion(input.value) });
            input.value = '';
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏ú‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å onclick ‡πÑ‡∏î‡πâ)
        window.deleteIssue = async (val) => {
            if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${val}?`)) {
                await updateDoc(settingsRef, { options: arrayRemove(val) });
            }
        };
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = "../index.html");
</script>
</body>
</html>
