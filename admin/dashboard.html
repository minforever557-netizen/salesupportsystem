<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .stats-grid { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .stat-card { flex: 1; min-width: 200px; padding: 20px; border-radius: 8px; text-align: center; color: #fff; }
        .bg-total { background: #10B981; }
        .bg-pending { background: #F59E0B; }
        .role-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        .issue-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .btn-delete { color: #ef4444; cursor: pointer; border: none; background: none; font-weight: bold; }
    </style>
</head>
<body>
    <nav style="background: var(--primary-green); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: bold;">Admin Dashboard (Real-time)</span>
        <button id="logoutBtn" style="background: none; border: 1px solid white; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>

    <div class="stats-grid" style="max-width: 1000px; margin: 20px auto; padding: 0 20px;">
        <div class="stat-card bg-total">
            <h4 style="margin: 0;">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <h2 id="totalTickets" style="margin: 10px 0; font-size: 2.5rem;">0</h2>
        </div>
        <div class="stat-card bg-pending">
            <h4 style="margin: 0;">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Open/In Progress)</h4>
            <h2 id="pendingTickets" style="margin: 10px 0; font-size: 2.5rem;">0</h2>
        </div>
    </div>

    <div class="green-container" style="max-width: 1000px; margin-top: 20px;">
        <h3 style="color: var(--primary-green); margin-top: 0;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Issue Types)</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newIssue" class="input-field" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">
            <button id="addIssueBtn" class="btn-green" style="width: 150px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
        </div>
        <div id="issueList" style="margin-top: 15px;">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...
        </div>
    </div>

    <div class="green-container" style="max-width: 1000px; margin-top: 20px; border-top: 6px solid #3B82F6;">
        <h3 style="color: #1E40AF; margin-top: 0;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
        <div style="overflow-x: auto;">
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #f4f4f4; text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #ddd;">Email</th>
                        <th style="padding: 12px; border-bottom: 2px solid #ddd;">Role</th>
                        <th style="padding: 12px; border-bottom: 2px solid #ddd;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "../index.html";
        } else {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === 'admin') {
                initRealtimeUpdates();
            } else {
                alert("‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                window.location.href = "../index.html";
            }
        }
    });

    function initRealtimeUpdates() {
        // 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Real-time)
        onSnapshot(collection(db, "tickets"), (snapshot) => {
            document.getElementById('totalTickets').innerText = snapshot.size;
            let pending = 0;
            snapshot.forEach(doc => {
                const status = doc.data().status;
                if (status === 'Open' || status === 'In Progress') pending++;
            });
            document.getElementById('pendingTickets').innerText = pending;
        });

        // 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤
        onSnapshot(doc(db, "settings", "issueOptions"), async (docSnap) => {
            const listDiv = document.getElementById('issueList');
            if (docSnap.exists()) {
                let html = '';
                docSnap.data().options.forEach(opt => {
                    html += `<div class="issue-item">${opt} <span class="btn-delete" onclick="window.removeIssue('${opt}')">‡∏•‡∏ö</span></div>`;
                });
                listDiv.innerHTML = html || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏ß‡πâ
                await setDoc(doc(db, "settings", "issueOptions"), { options: ["‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"] });
            }
        });

        // 3. ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User
        onSnapshot(collection(db, "users"), (snapshot) => {
            const tbody = document.getElementById('userTableBody');
            let html = '';
            snapshot.forEach(uDoc => {
                const u = uDoc.data();
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding:12px;">${u.email}</td>
                        <td style="padding:12px;"><b>${u.role}</b></td>
                        <td style="padding:12px;">
                            <select class="role-select" onchange="window.updateRole('${uDoc.id}', this.value)">
                                <option value="">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô...</option>
                                <option value="user">User (Sale)</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="admin">Admin</option>
                            </select>
                        </td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å (Global window)
    window.removeIssue = async (val) => {
        if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${val}?`)) {
            await updateDoc(doc(db, "settings", "issueOptions"), { options: arrayRemove(val) });
        }
    };

    window.updateRole = async (uid, newRole) => {
        if(!newRole) return;
        if(confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå User ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô ${newRole}?`)) {
            await updateDoc(doc(db, "users", uid), { role: newRole });
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
    };

    document.getElementById('addIssueBtn').addEventListener('click', async () => {
        const val = document.getElementById('newIssue').value.trim();
        if(!val) return;
        await updateDoc(doc(db, "settings", "issueOptions"), { options: arrayUnion(val) });
        document.getElementById('newIssue').value = "";
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = "../index.html");
    });

</script>
</body>
</html>
