<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sale Support</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <nav style="background: var(--primary-green); color: white; padding: 15px; display: flex; justify-content: space-between;">
        <span style="font-weight: bold;">Admin Management</span>
        <button id="logoutBtn" style="background: none; border: 1px solid white; color: white; cursor: pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>

    <div class="green-container" style="max-width: 1000px; margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px; background: #ECFDF5; padding: 20px; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #064E3B;">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <h2 id="totalTickets" style="margin: 10px 0;">0</h2>
        </div>
    </div>

    <div class="green-container" style="max-width: 1000px; margin-top: 20px;">
        <h3 style="color: var(--primary-green);">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Issue Types)</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newIssue" class="input-field" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
            <button id="addIssueBtn" class="btn-green" style="width: 150px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
        </div>
        <ul id="issueList" style="margin-top: 15px; list-style: none; padding: 0;"></ul>
    </div>

    <div class="green-container" style="max-width: 1000px; margin-top: 20px; border-top: 6px solid #3B82F6;">
        <h3 style="color: #1E40AF;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Management)</h3>
        <div style="overflow-x: auto;">
            <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #f4f4f4; text-align: left;">
                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">Email</th>
                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">Role</th>
                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ---
    async function loadIssueTypes() {
        const docRef = doc(db, "settings", "issueOptions");
        const docSnap = await getDoc(docRef);
        const list = document.getElementById('issueList');
        list.innerHTML = "";
        
        if (docSnap.exists()) {
            docSnap.data().options.forEach(opt => {
                const li = document.createElement('li');
                li.style = "display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;";
                li.innerHTML = `${opt} <button style="color:red; cursor:pointer; border:none; background:none;" onclick="window.removeIssue('${opt}')">‡∏•‡∏ö</button>`;
                list.appendChild(li);
            });
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Document ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
            await setDoc(docRef, { options: ["‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"] });
            loadIssueTypes();
        }
    }

    window.removeIssue = async (val) => {
        const docRef = doc(db, "settings", "issueOptions");
        await updateDoc(docRef, { options: arrayRemove(val) });
        loadIssueTypes();
    };

    document.getElementById('addIssueBtn').addEventListener('click', async () => {
        const val = document.getElementById('newIssue').value;
        if(!val) return;
        const docRef = doc(db, "settings", "issueOptions");
        await updateDoc(docRef, { options: arrayUnion(val) });
        document.getElementById('newIssue').value = "";
        loadIssueTypes();
    });

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ User ---
    async function loadAllUsers() {
        const querySnapshot = await getDocs(collection(db, "users"));
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = "";
        querySnapshot.forEach((uDoc) => {
            const u = uDoc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:10px;">${u.email}</td>
                <td style="padding:10px;">${u.role}</td>
                <td style="padding:10px;">
                    <select onchange="window.updateRole('${uDoc.id}', this.value)">
                        <option value="">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
                        <option value="user">User</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Admin</option>
                    </select>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.updateRole = async (uid, role) => {
        if(!role) return;
        await updateDoc(doc(db, "users", uid), { role: role });
        alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        loadAllUsers();
    };

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href="../index.html"));

    // ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
    loadIssueTypes();
    loadAllUsers();
</script>
</body>
</html>
