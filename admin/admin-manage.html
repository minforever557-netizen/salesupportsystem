<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Case</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .detail-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .label { color: #6b7280; font-size: 0.85rem; display: block; margin-bottom: 5px; }
        .value { font-weight: 600; color: #111827; }
        .badge-current { padding: 4px 12px; border-radius: 15px; background: #e5e7eb; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="main-content" style="margin-left: 0; padding: 20px;">
        <div class="container" style="max-width: 800px;">
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <button onclick="history.back()" style="background:none; border:none; cursor:pointer; font-size: 1.2rem;">‚¨ÖÔ∏è</button>
                <h2 style="margin:0;">üõ† ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™ (‡πÇ‡∏´‡∏°‡∏î Admin)</h2>
            </div>

            <div class="detail-card">
                <div class="info-grid">
                    <div>
                        <span class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç INTERNET</span>
                        <div class="value" id="dispInternet">-</div>
                    </div>
                    <div>
                        <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                        <span class="badge-current" id="dispStatus">-</span>
                    </div>
                    <div>
                        <span class="label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Sale)</span>
                        <div class="value" id="dispSale">-</div>
                    </div>
                    <div>
                        <span class="label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                        <div class="value" id="dispTopic">-</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å Sale</span>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #edf2f7;" id="dispDetail">-</div>
                </div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

                <form id="updateForm">
                    <div style="margin-bottom: 15px;">
                        <label class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Admin (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sale)</label>
                        <textarea id="adminComment" class="input-field" style="height: 120px;" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥..."></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label class="label">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="selectStatus" class="input-field">
                            <option value="Open">Open (‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà)</option>
                            <option value="In Progress">In Progress (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</option>
                            <option value="Closed">Closed (‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™)</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-save" style="flex: 2; background: #111827; color:white; padding: 12px; border:none; border-radius: 8px; font-weight:600; cursor:pointer;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                        <button type="button" onclick="history.back()" style="flex: 1; background: #f3f4f6; border:none; border-radius: 8px; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ticketId = localStorage.getItem('editTicketId');

    if (!ticketId) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™");
        window.location.href = 'history_all.html';
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    async function loadData() {
        const docRef = doc(db, "tickets", ticketId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('dispInternet').innerText = data.internetNo;
            document.getElementById('dispStatus').innerText = data.status;
            document.getElementById('dispSale').innerText = data.email;
            document.getElementById('dispTopic').innerText = data.topic || data.issueType || '-';
            document.getElementById('dispDetail').innerText = data.detail || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            document.getElementById('adminComment').value = data.comment || '';
            document.getElementById('selectStatus').value = data.status;
        }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    document.getElementById('updateForm').onsubmit = async (e) => {
        e.preventDefault();
        const docRef = doc(db, "tickets", ticketId);
        
        try {
            await updateDoc(docRef, {
                comment: document.getElementById('adminComment').value,
                status: document.getElementById('selectStatus').value,
                updatedAt: serverTimestamp(),
                processedByAdmin: "Admin" // ‡πÄ‡∏û‡∏¥‡πà‡∏° tag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            });
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            window.location.href = 'history_all.html';
        } catch (error) {
            console.error(error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }
    };

    loadData();
</script>
</body>
</html>
