<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™ (‡πÇ‡∏´‡∏°‡∏î Admin)</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .manage-container { max-width: 800px; margin: 30px auto; padding: 20px; }
        .data-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .info-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .label { display: block; font-size: 13px; color: #64748b; margin-bottom: 5px; }
        .value { font-weight: 600; color: #1e293b; font-size: 15px; }
        .detail-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; min-height: 80px; }
        .status-now { padding: 4px 12px; border-radius: 20px; font-size: 12px; }
    </style>
</head>
<body style="background: #f1f5f9;">

    <div class="manage-container">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <a href="main.html" style="text-decoration: none; font-size: 20px;">‚¨ÖÔ∏è</a>
            <h2 style="margin:0;">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™ (‡πÇ‡∏´‡∏°‡∏î Admin)</h2>
        </div>

        <div class="data-card">
            <div class="info-row">
                <div>
                    <span class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç INTERNET</span>
                    <div id="dispInternet" class="value">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
                <div>
                    <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                    <div id="dispStatus" class="value">-</div>
                </div>
            </div>

            <div class="info-row">
                <div>
                    <span class="label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Sale)</span>
                    <div id="dispSale" class="value">-</div>
                </div>
                <div>
                    <span class="label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                    <div id="dispTopic" class="value">-</div>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <span class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å Sale</span>
                <div id="dispDetail" class="detail-box">-</div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

            <form id="updateForm">
                <div style="margin-bottom: 20px;">
                    <label class="label" style="color: #1e293b; font-weight: 600;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Admin (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Sale)</label>
                    <textarea id="adminNote" class="input-field" rows="5" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥..." required></textarea>
                </div>

                <div style="margin-bottom: 25px;">
                    <label class="label" style="color: #1e293b; font-weight: 600;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="selectStatus" class="input-field">
                        <option value="Open">Open (‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà)</option>
                        <option value="In Progress">In Progress (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</option>
                        <option value="Closed">Closed (‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</option>
                    </select>
                </div>

                <div style="display: flex; gap: 15px;">
                    <button type="submit" class="btn" style="flex: 2; background: #1e293b; color: white; height: 50px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                    <button type="button" onclick="history.back()" class="btn" style="flex: 1; background: #e2e8f0; color: #475569; height: 50px; border: none; border-radius: 8px; cursor: pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCsUhBsWjZfQuJo5lgprYt3xikQUyf8iiw",
        authDomain: "sale-support-system.firebaseapp.com",
        projectId: "sale-support-system",
        storageBucket: "sale-support-system.firebasestorage.app",
        messagingSenderId: "640337786680",
        appId: "1:640337786680:web:fd80699ac291b8d7a7b3cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™ Ticket ‡∏à‡∏≤‡∏Å localStorage
    const ticketId = localStorage.getItem('adminEditTicketId');

    async function loadTicketData() {
        if (!ticketId) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å");
            window.location.href = 'main.html';
            return;
        }

        try {
            const docRef = doc(db, "tickets", ticketId);
            const snap = await getDoc(docRef);

            if (snap.exists()) {
                const data = snap.data();
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI
                document.getElementById('dispInternet').innerText = data.internetNo || '-';
                document.getElementById('dispStatus').innerText = data.status || 'Open';
                document.getElementById('dispSale').innerText = data.email || '-';
                document.getElementById('dispTopic').innerText = data.topic || data.issueType || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                document.getElementById('dispDetail').innerText = data.detail || data.issueDetail || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
                
                // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                document.getElementById('selectStatus').value = data.status || 'Open';
                document.getElementById('adminNote').value = data.supNote || data.comment || '';
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                window.location.href = 'main.html';
            }
        } catch (error) {
            console.error("Error loading ticket:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.getElementById('updateForm').onsubmit = async (e) => {
        e.preventDefault();
        const newStatus = document.getElementById('selectStatus').value;
        const note = document.getElementById('adminNote').value;

        try {
            const docRef = doc(db, "tickets", ticketId);
            await updateDoc(docRef, {
                status: newStatus,
                supNote: note,        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á Admin
                comment: note,        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Sale
                updatedAt: serverTimestamp(),
                processedBy: "Admin"
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            window.location.href = 'main.html';
        } catch (error) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + error.message);
        }
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    loadTicketData();
</script>
</body>
</html>
